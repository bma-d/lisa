# Changelog - 260222

## 260222-00:50:37 - Harden Lisa orchestration reliability and skill clarity

### Summary
Stabilized Lisa multi-session orchestration behavior, closed monitor/smoke edge cases, and aligned skill/docs/contracts for more reliable LLM-driven automation.

### Added
- Added regression coverage for context-pack handoff/session mismatch handling.
- Added regression coverage for monitor JSONPath success semantics, precedence over marker checks, numeric expectations, and invalid expression handling.
- Added regression coverage for smoke chaos marker failure payloads and report-min chaos metadata.
- Added breadcrumb log for the latest fix/verification cycle.

### Changed
- Updated Lisa command/help/capability surfaces and skill data docs for orchestration-focused flows.
- Refined smoke chaos script generation to remove specific marker lines deterministically.
- Improved monitor stop-condition precedence so first-match semantics stay stable.

### Fixed
- Fixed `session context-pack` accepting mismatched `--for` and `--from-handoff` session identities.
- Fixed monitor JSON output emitting failure-like `errorCode` on successful `--until-jsonpath` matches.
- Fixed monitor stop-reason override where `--until-marker` could replace an already matched JSONPath reason.
- Fixed `session smoke --chaos mixed` line removal bug that could drop the session line and leave marker checks incorrect.

### Files
- `.agents/sdk-usage.md`
- `.breadcrumbs/260221.md`
- `.breadcrumbs/260222.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/feature-ideas.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/validation.md`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_session.go`
- `src/commands_session_manage.go`
- `src/commands_session_orchestration.go`
- `src/commands_session_smoke.go`
- `src/commands_session_state.go`
- `src/commands_skills.go`
- `src/help.go`
- `src/session_additional_ideas_test.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify context-pack mismatch guard: `./lisa session context-pack --for A --from-handoff handoff.json --json` returns `from_handoff_session_mismatch` when handoff session differs.
- Verify JSONPath success contract: `./lisa session monitor --session <s> --until-jsonpath '$.sessionState=waiting_input' --json-min` exits success without `errorCode`.
- Verify JSONPath precedence over marker when both configured: monitor should report `exitReason=jsonpath_matched` if JSONPath first-match occurs.
- Verify smoke chaos behavior: `./lisa session smoke --levels 4 --chaos mixed --json` and `--chaos drop-marker --json` produce expected marker assertions.
- Verify full regression suite: `go test ./...` and `go vet ./...`.

## 260222-02:17:00 - Add managed Claude OAuth token pool and automatic invalid-token pruning

### Summary
Introduced secure local OAuth token management for Claude spawns with round-robin rotation and crash-time auto-removal of invalid or expired tokens.

### Added
- Added `lisa oauth add|list|remove` command group for managing Claude OAuth token pool entries.
- Added secure local token store at `~/.lisa/oauth_tokens.json` with lock-guarded updates and `0600` permissions.
- Added regression tests covering OAuth token lifecycle, round-robin selection, spawn integration, and prune-on-failure behavior.

### Changed
- Updated `session spawn` to select a Claude OAuth token from the managed pool, inject it into tmux env, and record `oauthTokenId` in session metadata/JSON output.
- Updated help/capabilities/usage docs and project context docs to include OAuth command surfaces and runtime behavior.
- Updated command execution env filtering to avoid leaking internal runtime token-passing env vars.

### Fixed
- Fixed repeated Claude refresh-failure loops by detecting invalid/expired OAuth token errors in crashed/stuck sessions and automatically removing the failing token from the pool.

### Files
- `.agents/project-overview.md`
- `.breadcrumbs/260222.md`
- `AGENTS.md`
- `README.md`
- `USAGE.md`
- `src/.agents/session-lifecycle.md`
- `src/.agents/tmux-layer.md`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_oauth.go`
- `src/commands_session.go`
- `src/help.go`
- `src/help_test.go`
- `src/oauth_tokens.go`
- `src/oauth_tokens_test.go`
- `src/run.go`
- `src/status.go`
- `src/tmux.go`
- `src/types.go`
- `src/utils.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify OAuth add/list/remove workflow: `./lisa oauth add --stdin`, `./lisa oauth list --json`, `./lisa oauth remove --id <id> --json`.
- Verify round-robin token usage by adding 2+ tokens and running sequential Claude spawns with `--json` to confirm changing `oauthTokenId`.
- Verify Claude spawn receives token env only when managed tokens exist (check dry-run env payload and runtime behavior).
- Verify auto-prune behavior by simulating/observing `invalid_grant` or OAuth refresh-failed output in a crashed/stuck Claude session, then confirming token removal via `./lisa oauth list`.
- Verify regression suite: `go test ./...`.
