# Changelog - 260222

## 260222-00:50:37 - Harden Lisa orchestration reliability and skill clarity

### Summary
Stabilized Lisa multi-session orchestration behavior, closed monitor/smoke edge cases, and aligned skill/docs/contracts for more reliable LLM-driven automation.

### Added
- Added regression coverage for context-pack handoff/session mismatch handling.
- Added regression coverage for monitor JSONPath success semantics, precedence over marker checks, numeric expectations, and invalid expression handling.
- Added regression coverage for smoke chaos marker failure payloads and report-min chaos metadata.
- Added breadcrumb log for the latest fix/verification cycle.

### Changed
- Updated Lisa command/help/capability surfaces and skill data docs for orchestration-focused flows.
- Refined smoke chaos script generation to remove specific marker lines deterministically.
- Improved monitor stop-condition precedence so first-match semantics stay stable.

### Fixed
- Fixed `session context-pack` accepting mismatched `--for` and `--from-handoff` session identities.
- Fixed monitor JSON output emitting failure-like `errorCode` on successful `--until-jsonpath` matches.
- Fixed monitor stop-reason override where `--until-marker` could replace an already matched JSONPath reason.
- Fixed `session smoke --chaos mixed` line removal bug that could drop the session line and leave marker checks incorrect.

### Files
- `.agents/sdk-usage.md`
- `.breadcrumbs/260221.md`
- `.breadcrumbs/260222.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/feature-ideas.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/validation.md`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_session.go`
- `src/commands_session_manage.go`
- `src/commands_session_orchestration.go`
- `src/commands_session_smoke.go`
- `src/commands_session_state.go`
- `src/commands_skills.go`
- `src/help.go`
- `src/session_additional_ideas_test.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify context-pack mismatch guard: `./lisa session context-pack --for A --from-handoff handoff.json --json` returns `from_handoff_session_mismatch` when handoff session differs.
- Verify JSONPath success contract: `./lisa session monitor --session <s> --until-jsonpath '$.sessionState=waiting_input' --json-min` exits success without `errorCode`.
- Verify JSONPath precedence over marker when both configured: monitor should report `exitReason=jsonpath_matched` if JSONPath first-match occurs.
- Verify smoke chaos behavior: `./lisa session smoke --levels 4 --chaos mixed --json` and `--chaos drop-marker --json` produce expected marker assertions.
- Verify full regression suite: `go test ./...` and `go vet ./...`.

## 260222-02:17:00 - Add managed Claude OAuth token pool and automatic invalid-token pruning

### Summary
Introduced secure local OAuth token management for Claude spawns with round-robin rotation and crash-time auto-removal of invalid or expired tokens.

### Added
- Added `lisa oauth add|list|remove` command group for managing Claude OAuth token pool entries.
- Added secure local token store at `~/.lisa/oauth_tokens.json` with lock-guarded updates and `0600` permissions.
- Added regression tests covering OAuth token lifecycle, round-robin selection, spawn integration, and prune-on-failure behavior.

### Changed
- Updated `session spawn` to select a Claude OAuth token from the managed pool, inject it into tmux env, and record `oauthTokenId` in session metadata/JSON output.
- Updated help/capabilities/usage docs and project context docs to include OAuth command surfaces and runtime behavior.
- Updated command execution env filtering to avoid leaking internal runtime token-passing env vars.

### Fixed
- Fixed repeated Claude refresh-failure loops by detecting invalid/expired OAuth token errors in crashed/stuck sessions and automatically removing the failing token from the pool.

### Files
- `.agents/project-overview.md`
- `.breadcrumbs/260222.md`
- `AGENTS.md`
- `README.md`
- `USAGE.md`
- `src/.agents/session-lifecycle.md`
- `src/.agents/tmux-layer.md`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_oauth.go`
- `src/commands_session.go`
- `src/help.go`
- `src/help_test.go`
- `src/oauth_tokens.go`
- `src/oauth_tokens_test.go`
- `src/run.go`
- `src/status.go`
- `src/tmux.go`
- `src/types.go`
- `src/utils.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify OAuth add/list/remove workflow: `./lisa oauth add --stdin`, `./lisa oauth list --json`, `./lisa oauth remove --id <id> --json`.
- Verify round-robin token usage by adding 2+ tokens and running sequential Claude spawns with `--json` to confirm changing `oauthTokenId`.
- Verify Claude spawn receives token env only when managed tokens exist (check dry-run env payload and runtime behavior).
- Verify auto-prune behavior by simulating/observing `invalid_grant` or OAuth refresh-failed output in a crashed/stuck Claude session, then confirming token removal via `./lisa oauth list`.
- Verify regression suite: `go test ./...`.

## 260222-03:12:56 - Harden OAuth spawn reservations and lock doc contracts

### Summary
Closed concurrent Claude spawn token races, tightened reservation/rollback behavior, and added contract tests for usage/help flag parity.

### Added
- Added token reservation lifecycle support for managed Claude OAuth tokens (reserve, consume, release) with TTL cleanup for stale reservations.
- Added regression coverage for concurrent Claude spawns reserving distinct tokens and succeeding without OAuth selection conflicts.
- Added `src/docs_contract_test.go` to enforce critical USAGE contract flags/sections.

### Changed
- Updated `session spawn` OAuth flow to reserve before tmux creation, consume only after metadata persistence, and release reservations on failure paths.
- Updated USAGE docs with missing contract details (`session guard --enforce`, `session smoke --chaos` modes) and strengthened flag discoverability.
- Expanded help/capabilities tests to keep monitor/context-pack/route/autopilot/doc parity from drifting.

### Fixed
- Fixed a high-severity concurrency regression where near-simultaneous Claude spawns could race for the same token and fail with `spawn_oauth_selection_failed`.
- Fixed remaining OAuth handling edge cases so failed tmux/meta paths do not leave token reservations orphaned or consume rotation state prematurely.

### Files
- `.breadcrumbs/260222.md`
- `USAGE.md`
- `src/commands_capabilities_test.go`
- `src/commands_session.go`
- `src/docs_contract_test.go`
- `src/hardening_test.go`
- `src/help_test.go`
- `src/oauth_tokens.go`
- `src/oauth_tokens_test.go`
- `src/tmux.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify concurrent Claude spawns (2+ in parallel) no longer fail with `spawn_oauth_selection_failed` when multiple tokens are available.
- Verify reservation rollback: force tmux/session metadata failure and confirm token remains available for subsequent spawns.
- Verify token secrecy: ensure `CLAUDE_CODE_OAUTH_TOKEN` is not present in tmux command args output.
- Verify docs contract test remains green: `go test ./src -run TestUsageDocSessionContract -count=1`.
- Verify full regression suite: `go test ./...`.

## 260222-04:51:09 - Expand session orchestration contracts and close parity gaps

### Summary
Added packet/delta/resume orchestration primitives, fixed monitor/list/preflight/tree contract edge cases, and synced Lisa skill docs/install targets.

### Added
- Added `session packet` for one-call status + capture summary + handoff payload generation.
- Added new orchestration flags for delta/resume flows (`--handoff-cursor-file`, `--delta-json`, `--resume-from`, `--from-state`, `--markers-json`, `--why`, `--advice-only`, `--fast`).
- Added breadcrumb trail entries for implementation and multi-agent review/fix iterations.

### Changed
- Updated help/capabilities surfaces and skill docs to match runtime contracts for monitor gate success semantics and resume/stdin behaviors.
- Updated skill guidance to use `LISA_TMUX_SOCKET_DIR` with project-root scoped socket computation.
- Synced repo skill updates to both Codex and Claude installed skill targets.

### Fixed
- Fixed `session monitor --until-state` to accept runtime state `just_started`.
- Fixed `session list` to reject `--cursor-file` unless `--delta-json` is enabled.
- Fixed `session preflight --fast` to run reduced contract checks once instead of running full checks first.
- Fixed `session tree --json-min` count semantics so `filteredNodeCount` reflects dropped sessions.

### Files
- `.breadcrumbs/260222.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/feature-ideas.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/runtime.md`
- `skills/lisa/data/validation.md`
- `src/capture_markers.go`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_session.go`
- `src/commands_session_detect_nested.go`
- `src/commands_session_manage.go`
- `src/commands_session_orchestration.go`
- `src/commands_session_packet.go`
- `src/commands_session_preflight.go`
- `src/commands_session_state.go`
- `src/commands_session_tree.go`
- `src/help.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify `session list --cursor-file /tmp/x --json` fails with `cursor_file_requires_delta_json`, and `--delta-json` mode persists cursor snapshots.
- Verify `session monitor --until-state just_started` parses and runs without `invalid_until_state`.
- Verify `session preflight --json` vs `--fast --json` contract counts differ (fast lower) while both remain healthy.
- Verify `session tree --json-min` reports coherent `nodeCount/totalNodeCount/filteredNodeCount` in both default and `--active-only` modes.
- Verify skill parity: `./lisa skills doctor --json` reports Codex + Claude targets `up_to_date`.
- Verify regression suite: `go test ./...`.

## 260222-07:05:48 - Ship advanced session orchestration tooling and contract hardening

### Summary
Implemented new orchestration primitives, closed schema/help/USAGE drift, and expanded regression coverage through multi-agent review iterations.

### Added
- Added `session schema`, `session checkpoint`, and `session dedupe` command surfaces for machine-readable contracts, resumable bundles, and duplicate-work guards.
- Added advanced orchestration options including packet field projection, context-pack redaction, route topology/cost estimate, monitor event-budget, list priority scoring, capture semantic delta, and smoke chaos contracts.
- Added targeted regression suites for payload helper behavior and negative-path flag validation.

### Changed
- Updated help/capabilities/output contracts and command docs to keep CLI/runtime parity for the expanded session feature set.
- Updated Lisa skill docs (`skills/lisa/*`) and `USAGE.md` to reflect new commands, flags, and contract semantics.
- Updated breadcrumbs with implementation + iterative review/fix trail.

### Fixed
- Fixed schema catalog drift versus runtime JSON payloads for capture/context-pack/guard/dedupe.
- Fixed smoke monitor waiting behavior under chaos delay conditions and preserved autopilot resume mode/goal semantics.
- Fixed remaining documentation contract gaps flagged by multi-subagent review passes.

### Files
- `.breadcrumbs/260222.md`
- `USAGE.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/feature-ideas.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/validation.md`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_session.go`
- `src/commands_session_extended.go`
- `src/commands_session_manage.go`
- `src/commands_session_orchestration.go`
- `src/commands_session_packet.go`
- `src/commands_session_smoke.go`
- `src/commands_session_state.go`
- `src/help.go`
- `src/help_test.go`
- `src/session_payload_tools.go`
- `src/session_payload_tools_test.go`
- `src/session_requested_features_test.go`
- `docs/changelog/260222.md`

### QA Notes
- Verify schema parity: `./lisa session schema --command "session guard" --json` and `./lisa session schema --command "session dedupe" --json` include runtime keys.
- Verify route/context-pack additions: `./lisa session route --goal nested --topology planner,workers,reviewer --cost-estimate --json` and `./lisa session context-pack --for <session> --redact secrets,emails --json`.
- Verify capture/monitor additions: `./lisa session capture --session <session> --raw --semantic-delta --cursor-file /tmp/lisa.cursor --json` and `./lisa session monitor --session <session> --stream-json --emit-handoff --event-budget 320 --json`.
- Verify regression suite: `go test ./...` and build `go build -o ./lisa .`.


## 260222-19:49:28 - Sync skill docs and align per-agent test models

### Summary
Synced vendored Lisa skill docs from Codex source and aligned test model fixtures by agent.

### Changed
- Synced `skills/lisa` docs/data files from installed Codex skill source.
- Updated Claude command-building test fixture to use `--model haiku` while keeping Codex tests pinned to `GPT-5.3-Codex-Spark`.
- Logged breadcrumb note for model-fixture split validation.

### Files
- `.breadcrumbs/260222.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/feature-ideas.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/validation.md`
- `src/command_coverage_test.go`
- `docs/changelog/260222.md`

### QA Notes
- N/A (no runtime behavior change; docs + test fixtures only).
