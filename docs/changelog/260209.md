# Changelog - 260209

## 260209-22:01:49 - Harden exec completion and session scoping regressions

### Summary
Added regression hardening and tests for exec completion markers, output artifact tail retention, and project-only session isolation.

### Changed
- Added `buildFallbackScriptBody(...)` in `src/tmux.go` and route long-command fallback scripts through it.
- Added `tailLines(...)` in `src/session_files.go` to make latest-line retention explicit and reusable.
- Added regression tests in `src/regressions_test.go` covering the reviewed failure modes.

### Fixed
- [P1] Preserved exec completion marker emission for long exec commands by forcing `set +e` in fallback scripts when wrapped exec markers are present.
- [P2] Ensured persisted output artifacts keep newest pane lines (tail semantics) so end-of-run results/errors are retained.
- [P2] Verified project-only filtering uses unique project identity (`LISA_PROJECT_HASH`) and safe legacy fallback rather than basename-only matching.

### Files
- `src/tmux.go`
- `src/session_files.go`
- `src/regressions_test.go`
- `docs/changelog/260209.md`

### QA Notes
- `go test ./...`

## 260209-23:10:50 - Harden session artifact safety and validation

### Summary
Improved session safety and correctness by validating agent/mode flags, sanitizing artifact naming, canonicalizing project roots, and tightening artifact file permissions.

### Added
- Added strict parser helpers for agent/mode values and auto-aware hint parsing for status/monitor.
- Added regression tests for doctor readiness semantics, invalid flag rejection, wildcard cleanup isolation, unsafe session names, canonical root hashing, and file permissions.

### Changed
- Updated doctor readiness to require `tmux` and at least one available agent (`claude` or `codex`).
- Normalized project roots before hash/list/status/cleanup operations so equivalent paths map to one project identity.
- Routed long-command fallback scripts through sanitized session artifact identifiers.

### Fixed
- [P1] Prevented wildcard session names from deleting unrelated `/tmp/lisa-cmd-*.sh` artifacts.
- [P1] Prevented slash-containing session names from breaking metadata/state/output persistence.
- [P2] Changed session metadata/state/output artifacts to private permissions (`0600`) to avoid world-readable leakage.
- [P3] Stopped silent fallback for invalid `--agent` and `--mode` values by returning explicit validation errors.

### Files
- `src/agent_command.go`
- `src/commands_agent.go`
- `src/commands_session.go`
- `src/regressions_test.go`
- `src/session_files.go`
- `src/tmux.go`
- `src/utils.go`
- `docs/changelog/260209.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`
- `go vet ./...`

## 260209-23:36:56 - Propagate kill and status tmux errors

### Summary
Made session termination and status inspection report real tmux failures instead of returning false success states.

### Changed
- Added injectable tmux function hooks in `src/tmux.go` so command/status behavior can be validated deterministically in tests.
- Updated pane status helpers to return explicit errors when tmux display lookups fail.
- Expanded regression coverage for kill and status error paths in `src/regressions_test.go`.

### Fixed
- [P2] `session kill` now returns non-zero when the target session does not exist or tmux kill fails.
- [P2] `session kill-all` now returns non-zero on partial cleanup/kill failures and reports per-session errors.
- [P2] Session status computation now fails fast when tmux capture/display/pid reads fail, avoiding incorrect inferred states.

### Files
- `src/commands_session.go`
- `src/status.go`
- `src/tmux.go`
- `src/regressions_test.go`
- `docs/changelog/260209.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`
- `go vet ./...`
