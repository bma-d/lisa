# Changelog - 260223

## 260223-01:27:50 - Expand session contracts and multi-agent orchestration coverage

### Summary
Added new session contract/governance features, aligned skill docs with CLI capabilities, and hardened tests after multi-agent review cycles.

### Added
- `session contract-check` command for schema/docs contract validation.
- New orchestration flags: `--timeout-seconds`, `--since`, `--strict`, `--dedupe`, `--profile`, `--compress`, `--watch-json`, `--watch-interval`, `--watch-cycles`, `--export-artifacts`, `--contract-check`.
- Additional tests for help routing, capabilities error/help paths, and `skills doctor --contract-check` drift detection.

### Changed
- Updated `capabilities` + help surfaces to include all new commands/flags.
- Extended session explain/event tail cursor behavior and list watch streaming behavior.
- Updated Lisa skill docs to reflect current route/handoff/context-pack/smoke/list contracts.

### Fixed
- Closed command/flag drift between Lisa skill docs and actual CLI output.
- Removed test blind spots that could miss help/capability/contract regressions.

### Files
- `.breadcrumbs/260223.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/validation.md`
- `src/commands_capabilities.go`
- `src/commands_capabilities_test.go`
- `src/commands_session.go`
- `src/commands_session_explain.go`
- `src/commands_session_extended.go`
- `src/commands_session_manage.go`
- `src/commands_session_orchestration.go`
- `src/commands_session_smoke.go`
- `src/commands_session_state.go`
- `src/commands_session_tree.go`
- `src/commands_skills.go`
- `src/help.go`
- `src/help_test.go`
- `src/session_observability.go`
- `src/commands_session_governance.go`
- `src/commands_session_planning.go`
- `src/commands_skills_doctor_fix_test.go`

### QA Notes
- Run `go test ./...` and verify pass.
- Verify `go run . session contract-check --json` returns `ok:true`.
- Verify `go run . skills doctor --contract-check --json` returns `ok:true` for repo + installed targets.
- Manually sanity-check `session list --watch-json --watch-interval 1 --watch-cycles 1 --json-min` output shape.

## 260223-02:19:22 - Enforce watch-json minimal stream and close skill flag drift

### Summary
Fixed watch stream semantics, synced Lisa skill command flags, and added regression coverage.

### Added
- Regression tests for watch-json contract, handoff compression payload, smoke artifact export, route profile presets, and active-only list filtering.

### Changed
- `session list --watch-json` now always enforces `--json-min` output in watch loop invocations.
- Session list help text now documents the correct `--watch-interval` default (`2`).
- Lisa skill command docs now include missing monitor and orchestration flag surfaces.

### Fixed
- Prevented watch mode from emitting heavier full-json payloads when callers pass `--json`.
- Removed command/flag parity drift between skill docs and runtime capabilities.

### Files
- `.breadcrumbs/260223.md`
- `skills/lisa/data/commands.md`
- `src/commands_session_manage.go`
- `src/help.go`
- `src/session_watch_and_contract_regression_test.go`

### QA Notes
- Run `go test ./src -run 'TestCmdSessionListWatchForcesJSONMin|TestCmdSessionHandoffCompressZstdOmitsRecent|TestMaybeExportSmokeArtifactsCopiesWorkdir|TestCmdSessionRouteProfilePreset|TestCmdSessionListActiveOnlyWithoutNextAction|TestUsageDocSessionContract' -count=1`.
- Verify `./lisa skills doctor --repo-root . --contract-check --json` returns `ok:true`.
- Verify `./lisa session list --watch-json --watch-cycles 1 --project-root . --json` emits compact delta-json output.

## 260223-03:53:19 - Close review loop for objective/lane contracts and CI matrix

### Summary
Addressed all multi-agent review findings, hardened runtime contract enforcement, expanded direct command tests, and wired contract matrix into CI.

### Added
- Direct command tests for `session lane` CRUD JSON contract and `session memory --refresh --json` delta payload contract.
- CI `contract-matrix` job running `scripts/lisa-contract-matrix.sh` on push/PR.

### Changed
- `session send` objective reminder prepend now works when objective goal is empty but objective context exists.
- `session handoff` enforces lane contract requirements for schema v2 (`handoff_schema_v2_required`).
- Lisa skill docs command index and JSON surface now include `session budget-plan|objective|memory|lane`.

### Fixed
- Removed contract drift between skill docs and runtime for newly added session commands.
- Closed regression gaps around lane contracts and memory delta metadata outputs.

### Files
- `.github/workflows/ci.yml`
- `skills/lisa/data/commands.md`
- `src/commands_session.go`
- `src/commands_session_context.go`
- `src/commands_session_orchestration.go`
- `src/session_context_commands_direct_test.go`
- `src/session_send_handoff_contract_fix_test.go`
- `scripts/lisa-contract-matrix.sh`

### QA Notes
- Verify `go test ./...` passes.
- Verify `./scripts/lisa-contract-matrix.sh .` reports `pass=10 fail=0`.
- Verify `./lisa session contract-check --json` returns `ok:true`.

## 260223-03:52:49 - Close review loop for objective/lane contracts and CI matrix

### Summary
Addressed all multi-agent review findings, hardened runtime contract enforcement, expanded direct command tests, and wired contract matrix into CI.

### Added
- Direct command tests for  CRUD JSON contract and  delta payload contract.
- CI  job running PASS [capabilities-core]
PASS [objective-upsert]
PASS [lane-upsert]
PASS [spawn-lane-objective-dryrun]
PASS [detect-nested-trigger]
PASS [detect-nested-nontrigger]
PASS [route-queue]
PASS [budget-plan]
PASS [guard-policy]
PASS [smoke-llm-profile]

Contract matrix summary: pass=10 fail=0 on push/PR.

### Changed
-  objective reminder prepend now works when objective goal is empty but objective context exists.
-  enforces lane contract requirements for schema v2 ().
- Lisa skill docs command index and JSON surface now include .

### Fixed
- Removed contract drift between skill docs and runtime for newly added session commands.
- Closed regression gaps around lane contracts and memory delta metadata outputs.

### Files
- 
- 
- 
- 
- 
- 
- 
- PASS [capabilities-core]
PASS [objective-upsert]
PASS [lane-upsert]
PASS [spawn-lane-objective-dryrun]
PASS [detect-nested-trigger]
PASS [detect-nested-nontrigger]
PASS [route-queue]
PASS [budget-plan]
PASS [guard-policy]
PASS [smoke-llm-profile]

Contract matrix summary: pass=10 fail=0

### QA Notes
- Verify ?   	github.com/bma-d/lisa	[no test files]
ok  	github.com/bma-d/lisa/src	(cached) passes.
- Verify PASS [capabilities-core]
PASS [objective-upsert]
PASS [lane-upsert]
PASS [spawn-lane-objective-dryrun]
PASS [detect-nested-trigger]
PASS [detect-nested-nontrigger]
PASS [route-queue]
PASS [budget-plan]
PASS [guard-policy]
PASS [smoke-llm-profile]

Contract matrix summary: pass=10 fail=0 reports .
- Verify {"checks":[{"checked":15,"name":"schema_coverage","ok":true},{"checked":1,"name":"skill_commands_doc_read","ok":true},{"checked":48,"name":"skill_command_index_coverage","ok":true},{"checked":394,"name":"skill_flag_surface_coverage","ok":true}],"ok":true,"projectRoot":"/Users/joon/projects/twoj/tools/lisa","stderrPolicy":"diagnostic"} returns .

## 260223-05:16:04 - Stabilize codex interactive follow-up sends

### Summary
Hardened Codex interactive send behavior so same-session follow-up prompts submit reliably without manual extra Enter.

### Added
- Hermetic multi-turn interactive E2E coverage for same-session follow-up marker detection.
- Unit regression coverage for Codex interactive split-submit send path.

### Changed
- session send --text ... --enter now uses a staged submit path for Codex interactive sessions (text send + follow-up Enter).
- Objective reminder prefix in Codex interactive sends now stays single-line with user prompt text.
- tmux text-send buffer cleanup ordering now deletes buffer immediately after paste.

### Fixed
- Eliminated second-turn stalls in Codex interactive flows that previously required manual extra Enter.

### Files
- .agents/sdk-usage.md
- USAGE.md
- src/commands_session.go
- src/tmux.go
- src/e2e_interactive_followup_fake_test.go
- src/session_send_handoff_contract_fix_test.go
- src/session_send_state_test.go
- src/.agents/testing.md

### QA Notes
- Run go test ./... and verify full pass.
- Verify interactive same-session flow: spawn Codex interactive session, send first prompt, then session send --text ... --enter follow-up; confirm second marker is detected without manual nudge.

## 260223-05:15:24 - Stabilize codex interactive follow-up sends

### Summary
Hardened Codex interactive send behavior so same-session follow-up prompts submit reliably without manual extra Enter.

### Added
- Hermetic multi-turn interactive E2E coverage for same-session follow-up marker detection.
- Unit regression coverage for Codex interactive split-submit send path.

### Changed
- \ now uses a staged submit path for Codex interactive sessions (text send + follow-up Enter).
- Objective reminder prefix in Codex interactive sends now stays single-line with user prompt text.
- tmux text-send buffer cleanup ordering now deletes buffer immediately after paste.

### Fixed
- Eliminated second-turn stalls in Codex interactive flows that previously required manual extra Enter.

### Files
- \
- \
- \
- \
- \
- \
- \
- \

### QA Notes
- Run \?   	github.com/bma-d/lisa	[no test files]
ok  	github.com/bma-d/lisa/src	70.622s and verify full pass.
- Verify interactive same-session flow: spawn Codex interactive session, send first prompt, then \ follow-up; confirm second marker is detected without manual nudge.

## 260223-14:56:41 - Harden ambiguity signaling, lock-safe pruning, and review-loop closure

### Summary
Closed the full Lisa review/fix loop with clean subagent passes by hardening session root resolution, lock safety, and contract-visible warning surfaces.

### Added
- Ambiguous-root regression coverage for `session handoff`, `session status`, `session list`, `session aggregate`, and `session route --queue` (JSON + non-JSON warning paths).
- Lock-behavior regression for stale event pruning while lock contention exists.

### Changed
- Expanded checked project-root resolution usage across operational session commands.
- Surfaced ambiguous project-root warnings in non-JSON outputs for list/aggregate/route queue flows.
- Updated `USAGE.md` monitor/route/autopilot/guard/smoke flag coverage to match runtime/help surfaces.

### Fixed
- Prevented silent cross-project fallback in ambiguous session metadata scenarios.
- Enforced inclusive `session loop` budget caps at limit reached (`>=`).
- Added lock discipline to context-cache read/modify/write paths.
- Made stale event artifact pruning lock-safe against concurrent append/read activity.

### Files
- `USAGE.md`
- `src/session_files.go`
- `src/session_root_resolution.go`
- `src/session_observability.go`
- `src/commands_session_loop_cache.go`
- `src/commands_session_orchestration.go`
- `src/commands_session_manage.go`
- `src/commands_session_planning.go`
- `src/commands_session_state.go`
- `src/commands_session_context.go`
- `src/runtime_routing_regression_test.go`
- `src/session_feature_ideas_round4_test.go`
- `src/session_watch_and_contract_regression_test.go`
- `src/stability_findings_test.go`
- `src/docs_contract_test.go`

### QA Notes
- Run `go test ./...` and verify pass.
- Verify `./lisa session contract-check --project-root "$PWD" --json` returns `ok:true`.
- Verify `./lisa skills doctor --repo-root "$PWD" --contract-check --sync-plan --json` returns `ok:true`.
- Sanity check non-JSON warnings: `./lisa session list --with-next-action` and `./lisa session route --queue` should print ambiguity warnings when metadata is cross-project ambiguous.


## 260223-16:38:12 - Handle v2 handoff nextAction objects in context-pack

### Summary
Accepted v2/v3 handoff payloads in context-pack parsing, hardened invalid recent handling, and aligned docs/tests with lane schema contracts.

### Added
- Regression tests for v2 nextAction object parsing, command fallback parsing, and invalid recent payload failure path.

### Changed
- `session context-pack --from-handoff` parser now accepts v1 string and v2/v3 object forms of `nextAction`.
- Context-pack now prefers handoff-provided next action when sourced from handoff input.
- Help/usage/skill docs now explicitly document lane contract requirement for `session handoff --schema v2|v3` when `handoff_v2_required` is active.

### Fixed
- Stopped silently dropping malformed `recent` handoff payloads; now returns explicit invalid-from-handoff error.

### Files
- `src/commands_session_orchestration.go`
- `src/session_additional_ideas_test.go`
- `src/help.go`
- `USAGE.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/validation.md`
- `skills/lisa/data/recipes.md`
- `.agents/sdk-usage.md`

### QA Notes
- Verify `go test ./src -run 'TestSessionContextPackFromHandoff|TestSessionContextPackFromHandoffSchemaV2NextActionObject|TestSessionContextPackFromHandoffSchemaV2NextActionCommandFallback|TestSessionContextPackFromHandoffSessionMismatch|TestSessionContextPackFromHandoffInvalidRecent'` passes.
- Verify lane contract behavior: with `handoff_v2_required`, `session handoff --json-min` fails with `errorCode=handoff_schema_v2_required`, and `--schema v2` succeeds.
- Verify `session context-pack --from-handoff <handoff-v2.json> --json-min` succeeds and preserves nextAction/nextOffset.

## 260223-17:55:59 - Harden tmux inactive monitoring detection and review-loop fixes

### Summary
Improved status/process liveness inference for quiet wrapped sessions, closed reviewer findings, and expanded regression coverage.

### Added
- New regressions for nested/quoted shell payload parsing, wrapper flag handling (`timeout --kill-after`, `nice -n`), alias executables, and heartbeat-fresh no-PID classification.
- Incident note capturing the tmux inactive-looking pane behavior and triage details.

### Changed
- Session status classification now uses explicit heartbeat fallback reason: `heartbeat_fresh_agent_pid_unresolved`.
- `detectAgentProcess` matching now supports executable aliases and deeper wrapper chain parsing (`env`, `timeout`, shell `-c` payloads with command separators).
- Source context docs updated for state-machine/tmux-layer behavior changes.

### Fixed
- Reduced false "inactive/stuck" perception for quiet but live sessions when agent PID cannot be resolved.
- Removed shell payload false positives from plain text mentions (for example `echo codex`) while preserving real wrapped command detection.
- Resolved shell parser false negatives for single-token and multi-step wrapper payloads.

### Files
- `.breadcrumbs/260223.md`
- `docs-feedback/260223-1707-tmux-inactive-monitoring.md`
- `src/status.go`
- `src/tmux.go`
- `src/session_wrapper_test.go`
- `src/regressions_test.go`
- `src/.agents/state-machine.md`
- `src/.agents/tmux-layer.md`

### QA Notes
- Run `go test ./...` and verify pass.
- Verify quiet exec/interactive session with fresh heartbeat and unresolved agent PID reports `in_progress` with reason `heartbeat_fresh_agent_pid_unresolved`.
- Verify wrapped agent commands still resolve as active: `timeout 30 env ... bash -lc "codex exec ..."`.
- Verify non-agent shell text does not resolve as active agent process: `bash -lc "echo codex"`.

## 260223-17:55:18 - Harden tmux inactive monitoring detection and review-loop fixes

### Summary
Improved status/process liveness inference for quiet wrapped sessions, closed reviewer findings, and expanded regression coverage.

### Added
- New regressions for nested/quoted shell payload parsing, wrapper flag handling (, ), alias executables, and heartbeat-fresh no-PID classification.
- Incident note capturing the tmux inactive-looking pane behavior and triage details.

### Changed
- Session status classification now uses explicit heartbeat fallback reason: .
-  matching now supports executable aliases and deeper wrapper chain parsing (CODEX_CI=1
CODEX_INTERNAL_ORIGINATOR_OVERRIDE=Codex Desktop
CODEX_SHELL=1
CODEX_THREAD_ID=019c8c22-2700-7370-9b54-5d7e8db97261
COLORTERM=
COMMAND_MODE=unix2003
CPPFLAGS=-I/opt/homebrew/opt/ruby/include
DISABLE_AUTO_UPDATE=true
GEMINI_API_KEY=AIzaSyCw08SCpcgtcQGzU8Ei1fsaMFV4BTZ6oZg
GH_PAGER=cat
GIT_PAGER=cat
HOME=/Users/joon
HOMEBREW_CELLAR=/usr/local/Cellar
HOMEBREW_PREFIX=/usr/local
HOMEBREW_REPOSITORY=/usr/local/Homebrew
INFOPATH=/usr/local/share/info:/opt/homebrew/share/info:/usr/local/share/info:/opt/homebrew/share/info:
LANG=C.UTF-8
LC_ALL=C.UTF-8
LC_CTYPE=C.UTF-8
LDFLAGS=-L/opt/homebrew/opt/ruby/lib
LESS=-R
LOGNAME=joon
LSCOLORS=Gxfxcxdxbxegedabagacad
LS_COLORS=di=1;36:ln=35:so=32:pi=33:ex=31:bd=34;46:cd=34;43:su=30;41:sg=30;46:tw=30;42:ow=30;43
MallocNanoZone=0
NO_COLOR=1
NVM_BIN=/Users/joon/.nvm/versions/node/v22.20.0/bin
NVM_CD_FLAGS=-q
NVM_DIR=/Users/joon/.nvm
NVM_INC=/Users/joon/.nvm/versions/node/v22.20.0/include/node
OLDPWD=/Users/joon/projects/twoj/tools/lisa
OPENROUTER_API_KEY=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
P9K_SSH=0
PAGER=less
PATH=/Users/joon/.codex/tmp/arg0/codex-arg0iaL6P8:/Users/joon/.bun/bin:/Users/joon/.asdf/shims:/opt/homebrew/opt/ruby/bin:/Users/joon/.local/share/solana/install/active_release/bin:/Users/joon/.local/bin:/Users/joon/.nvm/versions/node/v22.20.0/bin:/Users/joon/.local/share/solana/install/active_release/bin:/Users/joon/Library/pnpm:/Users/joon/.pyenv/shims:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/local/sbin:/Users/joon/.local/share/solana/install/active_release/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/Library/Apple/usr/bin:/Users/joon/.cargo/bin:/Users/joon/.foundry/bin:/Users/joon/.lmstudio/bin:/Users/joon/go/bin:/Applications/Codex.app/Contents/Resources:/Users/joon/.foundry/bin:/Users/joon/.foundry/bin
PKG_CONFIG_PATH=/opt/homebrew/opt/ruby/lib/pkgconfig
PNPM_HOME=/Users/joon/Library/pnpm
PWD=/Users/joon/projects/twoj/tools/lisa
PYENV_ROOT=/Users/joon/.pyenv
RUST_LOG=warn
SHELL=/bin/zsh
SHLVL=2
SSH_AUTH_SOCK=/private/tmp/com.apple.launchd.82a2vPkUcx/Listeners
TERM=dumb
TMPDIR=/var/folders/jz/14kcb9hj7fn_7vhpynpf3gb00000gn/T/
USER=joon
XPC_FLAGS=0x0
XPC_SERVICE_NAME=0
ZSH=/Users/joon/.oh-my-zsh
ZSH_TMUX_AUTOSTART=false
ZSH_TMUX_AUTOSTARTED=true
_P9K_SSH_TTY=
__CFBundleIdentifier=com.openai.codex
__CF_USER_TEXT_ENCODING=0x1F5:0x0:0x2
_=/usr/bin/env, , shell  payloads with command separators).
- Source context docs updated for state-machine/tmux-layer behavior changes.

### Fixed
- Reduced false "inactive/stuck" perception for quiet but live sessions when agent PID cannot be resolved.
- Removed shell payload false positives from plain text mentions (e.g., codex) while preserving real wrapped command detection.
- Resolved shell parser false negatives for single-token and multi-step wrapper payloads.

### Files
- 
- 
- 
- 
- 
- 
- 
- 

### QA Notes
- Run ?   	github.com/bma-d/lisa	[no test files]
ok  	github.com/bma-d/lisa/src	88.639s and verify pass.
- Verify quiet exec/interactive session with fresh heartbeat and unresolved agent PID reports  with reason .
- Verify wrapped agent commands still resolve as active: .
- Verify non-agent shell text does not resolve as active agent process: codex.
