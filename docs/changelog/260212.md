# Changelog - 260212

## 260212-07:30:24 - Default --dangerously-skip-permissions for Claude agents

### Summary
Claude agents spawned by Lisa now include `--dangerously-skip-permissions` by default so tool calls are not denied in non-interactive tmux sessions.

### Changed
- `buildAgentCommand` injects `--dangerously-skip-permissions` for Claude agents by default; skips injection for Codex or when already present in `--agent-args`.
- `session spawn` and `agent build-cmd` accept `--no-dangerously-skip-permissions` to opt out.

### Fixed
- Spawned Claude sessions no longer run in "don't ask" mode where Bash tool calls are denied due to missing permission flags.

### Files
- `src/agent_command.go`
- `src/commands_agent.go`
- `src/commands_session.go`
- `src/command_coverage_test.go`
- `src/regressions_test.go`

### QA Notes
- `go test ./src/ -count=1` — all pass

## 260212-07:53:11 - Add --transcript flag to session capture

### Summary
`session capture --transcript` reads Claude's JSONL conversation file to return clean user/assistant messages instead of raw tmux pane output.

### Added
- `src/claude_session.go` — Claude JSONL parsing: session discovery via `history.jsonl` scan + project dir glob fallback, transcript extraction, plain/JSON output formatting.
- `src/claude_session_test.go` — 8 unit tests covering path encoding, message extraction, transcript reading, formatting, session discovery, capture flag, and metadata glob.
- `--transcript` and `--project-root` flags on `session capture`.
- `loadSessionMetaByGlob()` in `session_files.go` — discovers session metadata without knowing project root.

### Files
- `src/claude_session.go` (new)
- `src/claude_session_test.go` (new)
- `src/commands_session_state.go`
- `src/session_files.go`
- `src/run.go`

### QA Notes
- `go test ./src/ -count=1` — all pass

## 260212-08:58:13 - Per-command help system

### Summary
Every command now supports `--help`/`-h` with detailed flag descriptions, resolving `unknown flag: --help` errors.

### Added
- `src/help.go` — `isHelpFlag()`, `showHelp()` map dispatch, 16 `helpXxx()` functions covering all commands.
- `src/help_test.go` — exit-code, token, and routing-equivalence tests for all commands.
- Three equivalent routing styles: `lisa help session spawn`, `lisa session spawn --help`, `lisa session help spawn`.

### Changed
- `src/run.go` — `usage()` delegates to `helpTop()`; `help`/`--help`/`-h` routes through `showHelp()`.
- `src/commands_session.go` — help interception in router + `cmdSessionName`, `cmdSessionSpawn`, `cmdSessionSend` flag loops.
- `src/commands_session_state.go` — help in `cmdSessionStatus`, `cmdSessionMonitor`, `cmdSessionCapture` flag loops.
- `src/commands_session_explain.go` — help in `cmdSessionExplain` flag loop.
- `src/commands_session_manage.go` — help in `cmdSessionList`, `cmdSessionExists`, `cmdSessionKill`, `cmdSessionKillAll` flag loops.
- `src/commands_agent.go` — help interception in `cmdAgent` router + `cmdDoctor`, `cmdAgentBuildCmd` flag loops.

### Files
- `src/help.go` (new)
- `src/help_test.go` (new)
- `src/run.go`
- `src/commands_session.go`
- `src/commands_session_state.go`
- `src/commands_session_explain.go`
- `src/commands_session_manage.go`
- `src/commands_agent.go`

### QA Notes
- `go test ./src/... -count=1` — all pass

## 260212-09:40:55 - Transcript-based turn completion signal

### Summary
Claude interactive sessions now use JSONL transcript tail-reading to definitively detect turn completion, complementing the existing CPU/prompt heuristics.

### Added
- `checkTranscriptTurnComplete()` in `claude_session.go` — reads last 8KB of Claude's JSONL conversation file, skips progress/system entries, detects assistant turn completion via text content block presence + file staleness (>=3s).
- `claudeJSONLTailEntry` type and `assistantHasTextBlock()` helper.
- `ClaudeSessionID` field in `sessionState` for caching discovered session IDs across polls.
- `TranscriptTurnComplete`, `TranscriptFileAge`, `TranscriptError` signals in `statusSignals`.
- `transcript_turn_complete` classification reason in the status switch (between `interactiveWaiting` and `promptWaiting`).
- 5 unit tests in `claude_session_test.go` (text block, tool_use, progress skip, fresh file, user-last).
- 2 regression tests in `regressions_test.go` (transcript classification, transcript + high CPU).

### Changed
- `status.go` — transcript signal collection integrated into `computeSessionStatus` for Claude interactive mode; session ID cached in state file.
- `src/.agents/state-machine.md` — updated classification priority, signal sources, and observability docs.

### Files
- `src/claude_session.go`
- `src/claude_session_test.go`
- `src/status.go`
- `src/types.go`
- `src/regressions_test.go`
- `src/.agents/state-machine.md`

### QA Notes
- `go test ./src/ -count=1` — all pass (7 new tests)

## 260212-10:08:45 - Harden capture fallback and metadata disambiguation

### Summary
Default `session capture` now safely falls back to raw tmux output when transcript capture is unavailable, and metadata glob lookup is deterministic plus ambiguity-safe.

### Changed
- `session capture` uses transcript output only when session metadata resolves to Claude; otherwise raw pane capture.
- Claude transcript path now uses a shared helper (`captureSessionTranscript`) and supports silent fallback to raw output in default capture flow.
- Transcript output writing is centralized via `writeTranscriptCapture` for consistent plain/JSON payloads.

### Fixed
- `computeSessionStatus` now persists discovered `ClaudeSessionID` into session state, enabling real cache reuse across polls.
- `loadSessionMetaByGlob` no longer picks an arbitrary first match; it reads candidates, rejects cross-project ambiguity, and chooses the newest deterministic candidate.

### Files
- `src/commands_session_state.go`
- `src/claude_session.go`
- `src/session_files.go`
- `src/status.go`
- `src/claude_session_test.go`
- `src/regressions_test.go`

### QA Notes
- `go test ./...` — all pass

## 260212-10:44:19 - Codex transcript-based turn completion signal

### Summary
Codex interactive sessions now use JSONL transcript tail-reading to detect turn completion, mirroring the existing Claude transcript approach.

### Added
- `src/codex_session.go` — Codex session discovery via `~/.codex/history.jsonl`, session file lookup (sessions + archived_sessions globs), turn completion check reading last 8KB of session JSONL with backwards walk skipping `session_meta`/`turn_context`/`token_count` entries.
- `CodexSessionID` field in `sessionState` for caching across polls.
- 7 unit tests in `codex_session_test.go` (history lookup, session file discovery, archived fallback, assistant message, function_call rejection, token_count skip, fresh file guard).
- 1 regression test (`TestComputeSessionStatusCodexTranscriptTurnComplete`).

### Changed
- `status.go` — transcript check block refactored from Claude-only to `switch agent` handling both `claude` and `codex`; `CodexSessionID` persisted in state lock.

### Files
- `src/codex_session.go` (new)
- `src/codex_session_test.go` (new)
- `src/status.go`
- `src/types.go`
- `src/regressions_test.go`

### QA Notes
- `go test ./src/ -count=1` — all pass (8 new tests)
