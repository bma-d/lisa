# Changelog - 260220

## 260220-01:50:01 - Add strict waiting-input turn-complete monitor mode and transcript capture safeguards

### Summary

Added strict waiting stop semantics, hardened transcript matching/fallbacks, and expanded regression coverage for Claude/Codex interactive monitoring.

### Added

- Added `session monitor --waiting-requires-turn-complete true|false` (default `false`) for stricter waiting-input stop behavior.
- Added `waiting_input_turn_complete` monitor exit reason and lifecycle event reason path.
- Added dedicated tests for strict waiting behavior and Claude raw-fallback behavior in new test files.

### Changed

- Changed Codex transcript turn-complete parsing to skip non-terminal `event_msg` types (`task_started`, `task_complete`, `agent_reasoning`, `token_count`) before evaluating assistant completion.
- Split newly added monitor/capture tests into focused files to keep large test files from growing further.
- Updated help/usage and SDK/testing context docs for the strict waiting flag and capture fallback rules.

### Fixed

- Fixed stale/incorrect Claude transcript capture for promptless custom-command sessions by forcing transcript path to require prompt + createdAt metadata and falling back to raw capture otherwise.
- Fixed strict waiting mode false timeouts for Codex interactive sessions where trailing `task_complete` event messages previously masked assistant completion.

### Files

- `.agents/sdk-usage.md`
- `.breadcrumbs/260220.md`
- `USAGE.md`
- `docs/changelog/260220.md`
- `src/.agents/testing.md`
- `src/claude_capture_fallback_test.go`
- `src/claude_session.go`
- `src/codex_session.go`
- `src/codex_session_test.go`
- `src/command_coverage_test.go`
- `src/commands_session_state.go`
- `src/help.go`
- `src/monitor_waiting_turn_complete_test.go`

### QA Notes

- Verify `./lisa session monitor --session <name> --stop-on-waiting true --waiting-requires-turn-complete true --json` exits with `"exitReason":"waiting_input_turn_complete"` for interactive Claude and Codex sessions after assistant completion.
- Verify promptless/custom-command Claude sessions return raw capture payload (no stale `claudeSession` transcript payload) via `./lisa session capture --session <name> --json`.
- Verify Codex strict waiting mode no longer times out when transcript tail includes `task_complete` after assistant output.
- Verify `go test ./...` remains green.


## 260220-03:07:59 - Fix custom interactive waiting detection and send validation ordering

### Summary

Resolved waiting-input timeout for stdin-only `cat` interactive sessions and made `session send` argument errors deterministic before session lookup.

### Added

- Added targeted regressions for passive stdin-only `cat` detection and active `cat <file>` classification in process-tree inspection.
- Added E2E coverage ensuring `session monitor --stop-on-waiting true` stops with `waiting_input` for interactive custom `cat` sessions.
- Added CLI coverage that asserts `session send` validates `--text/--keys` exclusivity before tmux session lookup.

### Changed

- Changed interactive process-tree classification to treat stdin-only `cat` descendants as passive, while preserving active classification for file-argument `cat` commands.
- Changed `cmdSessionSend` flow to run payload validation before runtime/session checks, yielding stable user-facing validation errors.
- Updated state-machine context docs with the new passive-child heuristic.

### Fixed

- Fixed monitor false timeouts on custom interactive `--command cat` sessions by correctly classifying idle stdin wait as `waiting_input`.
- Fixed misleading `session not found` precedence for invalid `session send` payloads by surfacing validation errors first.

### Files

- `.breadcrumbs/260220.md`
- `src/.agents/state-machine.md`
- `src/commands_session.go`
- `src/coverage_cli_additional_test.go`
- `src/e2e_interactive_fake_test.go`
- `src/regressions_test.go`
- `src/tmux.go`

### QA Notes

- Verify `./lisa session spawn --mode interactive --command cat ...` followed by `./lisa session monitor --stop-on-waiting true --poll-interval 1 --max-polls 10 --json` exits with `"finalState":"waiting_input"` (not timeout).
- Verify `./lisa session send --session <missing> --text a --keys b` returns `use either --text or --keys, not both`.
- Verify full suite remains green: `go test ./...` and `go test -race ./src`.


## 260220-03:41:08 - Handle missing tmux sockets and filter Codex auth startup noise

### Summary

Normalized tmux missing-socket behavior for session listing and expanded raw capture noise filtering for Codex MCP auth-refresh startup output.

### Changed

- Changed tmux list behavior to treat missing-socket connection errors as an empty session set when listing sessions.
- Expanded raw capture noise filtering to remove Codex MCP OAuth refresh/auth startup noise fragments while preserving non-noise output.
- Added nested prompt-chain guidance in usage docs to reduce quoting failures for multi-level Lisa orchestration prompts.

### Fixed

- Fixed `session list --project-only --project-root <other-root>` returning non-zero on missing per-project socket.
- Fixed default raw capture retaining noisy `invalid_grant` MCP startup lines.

### Files

- `.agents/sdk-usage.md`
- `USAGE.md`
- `src/.agents/tmux-layer.md`
- `src/claude_session_test.go`
- `src/regressions_test.go`
- `src/tmux.go`
- `src/utils.go`

### QA Notes

- Verify `./lisa session list --project-only --project-root /tmp/<fresh-root>` exits `0` with empty output.
- Verify default `./lisa session capture --session <s> --raw` removes MCP OAuth startup noise while `--keep-noise` preserves it.
- Verify nested 3-level smoke still passes: `./smoke-nested`.
