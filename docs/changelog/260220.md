# Changelog - 260220

## 260220-01:50:01 - Add strict waiting-input turn-complete monitor mode and transcript capture safeguards

### Summary

Added strict waiting stop semantics, hardened transcript matching/fallbacks, and expanded regression coverage for Claude/Codex interactive monitoring.

### Added

- Added `session monitor --waiting-requires-turn-complete true|false` (default `false`) for stricter waiting-input stop behavior.
- Added `waiting_input_turn_complete` monitor exit reason and lifecycle event reason path.
- Added dedicated tests for strict waiting behavior and Claude raw-fallback behavior in new test files.

### Changed

- Changed Codex transcript turn-complete parsing to skip non-terminal `event_msg` types (`task_started`, `task_complete`, `agent_reasoning`, `token_count`) before evaluating assistant completion.
- Split newly added monitor/capture tests into focused files to keep large test files from growing further.
- Updated help/usage and SDK/testing context docs for the strict waiting flag and capture fallback rules.

### Fixed

- Fixed stale/incorrect Claude transcript capture for promptless custom-command sessions by forcing transcript path to require prompt + createdAt metadata and falling back to raw capture otherwise.
- Fixed strict waiting mode false timeouts for Codex interactive sessions where trailing `task_complete` event messages previously masked assistant completion.

### Files

- `.agents/sdk-usage.md`
- `.breadcrumbs/260220.md`
- `USAGE.md`
- `docs/changelog/260220.md`
- `src/.agents/testing.md`
- `src/claude_capture_fallback_test.go`
- `src/claude_session.go`
- `src/codex_session.go`
- `src/codex_session_test.go`
- `src/command_coverage_test.go`
- `src/commands_session_state.go`
- `src/help.go`
- `src/monitor_waiting_turn_complete_test.go`

### QA Notes

- Verify `./lisa session monitor --session <name> --stop-on-waiting true --waiting-requires-turn-complete true --json` exits with `"exitReason":"waiting_input_turn_complete"` for interactive Claude and Codex sessions after assistant completion.
- Verify promptless/custom-command Claude sessions return raw capture payload (no stale `claudeSession` transcript payload) via `./lisa session capture --session <name> --json`.
- Verify Codex strict waiting mode no longer times out when transcript tail includes `task_complete` after assistant output.
- Verify `go test ./...` remains green.


## 260220-03:07:59 - Fix custom interactive waiting detection and send validation ordering

### Summary

Resolved waiting-input timeout for stdin-only `cat` interactive sessions and made `session send` argument errors deterministic before session lookup.

### Added

- Added targeted regressions for passive stdin-only `cat` detection and active `cat <file>` classification in process-tree inspection.
- Added E2E coverage ensuring `session monitor --stop-on-waiting true` stops with `waiting_input` for interactive custom `cat` sessions.
- Added CLI coverage that asserts `session send` validates `--text/--keys` exclusivity before tmux session lookup.

### Changed

- Changed interactive process-tree classification to treat stdin-only `cat` descendants as passive, while preserving active classification for file-argument `cat` commands.
- Changed `cmdSessionSend` flow to run payload validation before runtime/session checks, yielding stable user-facing validation errors.
- Updated state-machine context docs with the new passive-child heuristic.

### Fixed

- Fixed monitor false timeouts on custom interactive `--command cat` sessions by correctly classifying idle stdin wait as `waiting_input`.
- Fixed misleading `session not found` precedence for invalid `session send` payloads by surfacing validation errors first.

### Files

- `.breadcrumbs/260220.md`
- `src/.agents/state-machine.md`
- `src/commands_session.go`
- `src/coverage_cli_additional_test.go`
- `src/e2e_interactive_fake_test.go`
- `src/regressions_test.go`
- `src/tmux.go`

### QA Notes

- Verify `./lisa session spawn --mode interactive --command cat ...` followed by `./lisa session monitor --stop-on-waiting true --poll-interval 1 --max-polls 10 --json` exits with `"finalState":"waiting_input"` (not timeout).
- Verify `./lisa session send --session <missing> --text a --keys b` returns `use either --text or --keys, not both`.
- Verify full suite remains green: `go test ./...` and `go test -race ./src`.


## 260220-03:41:08 - Handle missing tmux sockets and filter Codex auth startup noise

### Summary

Normalized tmux missing-socket behavior for session listing and expanded raw capture noise filtering for Codex MCP auth-refresh startup output.

### Changed

- Changed tmux list behavior to treat missing-socket connection errors as an empty session set when listing sessions.
- Expanded raw capture noise filtering to remove Codex MCP OAuth refresh/auth startup noise fragments while preserving non-noise output.
- Added nested prompt-chain guidance in usage docs to reduce quoting failures for multi-level Lisa orchestration prompts.

### Fixed

- Fixed `session list --project-only --project-root <other-root>` returning non-zero on missing per-project socket.
- Fixed default raw capture retaining noisy `invalid_grant` MCP startup lines.

### Files

- `.agents/sdk-usage.md`
- `USAGE.md`
- `src/.agents/tmux-layer.md`
- `src/claude_session_test.go`
- `src/regressions_test.go`
- `src/tmux.go`
- `src/utils.go`

### QA Notes

- Verify `./lisa session list --project-only --project-root /tmp/<fresh-root>` exits `0` with empty output.
- Verify default `./lisa session capture --session <s> --raw` removes MCP OAuth startup noise while `--keep-noise` preserves it.
- Verify nested 3-level smoke still passes: `./smoke-nested`.


## 260220-04:11:21 - Harden nested Codex orchestration and session lifecycle controls

### Summary

Improved nested Codex reliability, added descendant-aware session kill, and introduced strict not-found status exits with expanded regression coverage.

### Added

- Added `parentSession` metadata linkage for nested session trees.
- Added `session status --fail-not-found` for strict scriptable not-found handling.
- Added regressions for nested auto-bypass, descendant kill ordering, parent metadata capture, and strict status exit behavior.

### Changed

- Changed nested Codex exec spawning to auto-enable bypass sandbox mode when prompt text indicates Lisa nesting.
- Changed tmux socket routing to prefer `/tmp` and include compatibility fallback candidates for legacy socket locations.
- Changed `session kill` to resolve and terminate descendants before the requested parent session.
- Updated usage/help and context docs to reflect nested behavior, socket routing, and strict status semantics.

### Fixed

- Fixed nested Lisa-in-Lisa Codex exec failures caused by tmux socket permission constraints under full-auto sandboxing.
- Fixed orphaned child sessions after killing a parent nested session.
- Fixed inability to opt into non-zero status exit on `not_found`.

### Files

- `.agents/sdk-usage.md`
- `USAGE.md`
- `src/.agents/session-lifecycle.md`
- `src/.agents/tmux-layer.md`
- `src/commands_session.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/coverage_cli_additional_test.go`
- `src/help.go`
- `src/regressions_test.go`
- `src/runtime_routing_regression_test.go`
- `src/session_files.go`
- `src/stability_findings_test.go`
- `src/tmux.go`
- `src/tmux_runtime.go`
- `src/types.go`

### QA Notes

- Verify nested Codex flow with Lisa prompt chaining reaches completion and includes L1/L2/L3 markers.
- Verify `./lisa session kill --session <parent> --project-root .` removes descendants as well.
- Verify `./lisa session status --session <missing> --json --fail-not-found` exits 1, while default status stays exit 0.
- Verify full tests remain green: `go test ./...` and nested smoke `./smoke-nested`.

## 260220-05:07:28 - Fix waiting-state consistency and Codex turn-complete gating

### Summary

Aligned waiting semantics across status/monitor, matched nested Codex build-cmd behavior with spawn, and hardened waiting_input_turn_complete using submitted-input timestamps.

### Added

- Added submitted-input timestamp persistence in session state (, ) and recording on send events that submit input.
- Added regression coverage for effective poll-count waiting classification, send-input timestamp persistence, Codex assistant-turn-since checks, and strict waiting turn-complete behavior.

### Changed

- Changed one-shot  classification to derive effective poll count from persisted state so waiting/grace logic matches monitor progression.
- Changed  Codex exec behavior to auto-enable nested bypass sandbox mode for Lisa-nesting prompts, matching .
- Changed Codex strict waiting turn-complete gating to require transcript freshness relative to latest submitted input plus recent session-matched user-input evidence.

### Fixed

- Fixed mismatch where  reported  but immediate  remained .
- Fixed command preview/runtime divergence where  nested Codex exec still emitted  while spawn used bypass mode.
- Fixed false-positive  exits for Codex when no new post-input turn was actually complete.
- Fixed introduced false-negative timeout by adding Codex history fallback when transcript tail lacks explicit  events.

### Files

- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 
- 

### QA Notes

- Verify  and immediate  both report  for idle interactive sessions.
- Verify {"agent":"codex","command":"codex exec 'Use ./lisa ...' --skip-git-repo-check --dangerously-bypass-approvals-and-sandbox","mode":"exec","prompt":"Use ./lisa ..."} matches  command flags (, no ).
- Verify strict waiting gate behavior:
  - No real post-input turn: monitor with  reaches timeout.
  - Real follow-up assistant reply: monitor exits with .
- Verify full regression and nested smoke pass: ?   	github.com/bma-d/lisa	[no test files]
ok  	github.com/bma-d/lisa/src	(cached) and PASS: 3-level nested interactive Lisa smoke
L1=lisa-smoke-l1-20260220_050730_92669
L2=lisa-smoke-l2-20260220_050730_92669
L3=lisa-smoke-l3-20260220_050730_92669
Artifacts: /tmp/lisa-smoke-nested-20260220_050730_92669.

## 260220-06:28:16 - Add cleanup command and normalize terminal status outputs

### Summary

Added top-level cleanup tooling and fixed terminal status/finalStatus consistency plus tmux socket override reliability.

### Added

- Added top-level `cleanup` command with `--dry-run`, `--json`, and `--include-tmux-default` support.
- Added cleanup command implementation and targeted tests for apply/dry-run and tmux socket extraction.
- Added terminal-status normalization helpers for `session status` and `session monitor` outputs.

### Changed

- Changed monitor verbose poll logging to show normalized terminal status labels.
- Changed CLI help/usage/README and SDK integration docs to document cleanup command and normalized status contracts.
- Expanded regression coverage for status/finalStatus normalization across JSON/CSV/full-CSV and lifecycle event emission.

### Fixed

- Fixed explicit tmux socket override path usage in `runTmuxCmdWithSocket`.
- Fixed contradictory terminal outputs where `status` or `finalStatus` could be `idle` while lifecycle state was terminal.

### Files

- `.agents/sdk-usage.md`
- `.breadcrumbs/260220.md`
- `README.md`
- `USAGE.md`
- `docs/changelog/260220.md`
- `src/command_coverage_test.go`
- `src/commands_cleanup.go`
- `src/commands_cleanup_test.go`
- `src/commands_session_state.go`
- `src/coverage_cli_additional_test.go`
- `src/hardening_test.go`
- `src/help.go`
- `src/help_test.go`
- `src/run.go`
- `src/tmux.go`
- `src/tmux_socket_override_test.go`

### QA Notes

- Verify `./lisa cleanup --dry-run --json` reports candidates without mutation, then `./lisa cleanup --json` removes stale sockets only.
- Verify terminal consistency:
  - `./lisa session status --session <terminal-session> --json` returns matching `status` and `sessionState`.
  - `./lisa session monitor --session <terminal-session> --json` returns matching `finalStatus` and `finalState`.
- Verify explicit socket override path is honored when runtime socket env is set differently (covered by `go test ./...`).
- Verify regression suite remains green: `go test ./...`.

## 260220-07:13:16 - Persist turn-complete state across monitor/status and normalize explain terminal status

### Summary
Persisted waiting turn-complete markers so immediate status stays consistent after strict monitor exits, and normalized terminal status output in session explain.

### Changed

- Changed strict waiting monitor flow to persist turn-complete metadata in session state.
- Changed status computation to surface cached transcript turn-complete signals when marker freshness matches latest input.
- Changed explain command output to apply terminal status normalization consistently with session status.

### Fixed

- Fixed mismatch where monitor exited with `waiting_input_turn_complete` but immediate `session status` still showed `transcriptTurnComplete=false`.
- Fixed explain JSON/text showing `status=idle` for terminal states.
- Fixed initial-prompt edge case where no submitted-input timestamp prevented turn-complete carryover.

### Files

- `.breadcrumbs/260220.md`
- `docs/changelog/260220.md`
- `src/command_coverage_test.go`
- `src/commands_session_explain.go`
- `src/commands_session_state.go`
- `src/coverage_cli_additional_test.go`
- `src/monitor_waiting_turn_complete_test.go`
- `src/regressions_test.go`
- `src/status.go`
- `src/types.go`

### QA Notes

- Verify strict wait path: `./lisa session monitor --session <s> --stop-on-waiting true --waiting-requires-turn-complete true --json` exits with `exitReason=waiting_input_turn_complete`, then `./lisa session status --session <s> --json` returns `signals.transcriptTurnComplete=true`.
- Verify explain normalization on terminal failure: run crashing exec session, then `./lisa session explain --session <s> --json` reports `status.status == status.sessionState == crashed`.
- Verify regression safety: `go test ./...` and `./smoke-nested --project-root . --max-polls 120`.

## 260220-08:23:21 - Document cleanup semantics and capture compatibility flags

### Summary
Updated usage/help docs to clarify cleanup behavior, monitor/explain output semantics, and capture noise-filter compatibility aliases.

### Changed

- Documented cleanup probe/kill/remove behavior and error-exit semantics.
- Documented monitor waiting-input-turn-complete lifecycle reason and explain output normalization.
- Documented capture `--strip-noise` compatibility alias and spawn env-routing note.

### Files

- `.breadcrumbs/260220.md`
- `USAGE.md`
- `src/help.go`
- `docs/changelog/260220.md`

### QA Notes

- N/A (documentation/help text updates only)

## 260220-09:30:16 - Add session tree, dry-run spawn planning, cross-socket listing, and marker-based monitor stop

### Summary

Delivered four orchestration features with red-first regressions, live verification, and documentation/skill updates for LLM usability.

### Added

- Added `session tree` subcommand with JSON/text hierarchy output based on metadata parent-child links.
- Added `session spawn --dry-run` to emit resolved session plan (`command`, wrapped `startupCommand`, `socketPath`, injected env) without creating tmux sessions/artifacts.
- Added `session list --all-sockets` to discover active sessions across metadata-known project roots/sockets.
- Added `session monitor --until-marker <TEXT>` stop condition with successful `marker_found` exit path.
- Added red-first regression coverage for all four features in `src/features_regression_test.go`.

### Changed

- Updated help/CLI discoverability for new subcommand/flags.
- Updated usage + SDK + lifecycle context docs to codify new orchestration patterns.
- Updated Lisa skill guidance for LLM operators with feature details and output contracts.

### Files

- `.agents/sdk-usage.md`
- `.breadcrumbs/260220.md`
- `USAGE.md`
- `docs/changelog/260220.md`
- `src/.agents/session-lifecycle.md`
- `src/commands_session.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/commands_session_tree.go`
- `src/features_regression_test.go`
- `src/help.go`

### QA Notes

- Verify `./lisa session tree --project-root <root> --json` shows expected nested hierarchy for parent/child sessions.
- Verify `./lisa session spawn ... --dry-run --json` returns plan payload and does not create tmux session/meta artifacts.
- Verify `./lisa session list --project-root <root> --all-sockets` includes active sessions across sibling project roots.
- Verify `./lisa session monitor ... --until-marker <TOKEN> --json` exits `0` with `"exitReason":"marker_found"`.
- Verify regression + integration checks stay green: `go test ./...` and `./smoke-nested --project-root /Users/joon/projects/twoj/tools/lisa --max-polls 120`.
