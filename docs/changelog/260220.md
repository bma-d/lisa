# Changelog - 260220

## 260220-01:50:01 - Add strict waiting-input turn-complete monitor mode and transcript capture safeguards

### Summary

Added strict waiting stop semantics, hardened transcript matching/fallbacks, and expanded regression coverage for Claude/Codex interactive monitoring.

### Added

- Added `session monitor --waiting-requires-turn-complete true|false` (default `false`) for stricter waiting-input stop behavior.
- Added `waiting_input_turn_complete` monitor exit reason and lifecycle event reason path.
- Added dedicated tests for strict waiting behavior and Claude raw-fallback behavior in new test files.

### Changed

- Changed Codex transcript turn-complete parsing to skip non-terminal `event_msg` types (`task_started`, `task_complete`, `agent_reasoning`, `token_count`) before evaluating assistant completion.
- Split newly added monitor/capture tests into focused files to keep large test files from growing further.
- Updated help/usage and SDK/testing context docs for the strict waiting flag and capture fallback rules.

### Fixed

- Fixed stale/incorrect Claude transcript capture for promptless custom-command sessions by forcing transcript path to require prompt + createdAt metadata and falling back to raw capture otherwise.
- Fixed strict waiting mode false timeouts for Codex interactive sessions where trailing `task_complete` event messages previously masked assistant completion.

### Files

- `.agents/sdk-usage.md`
- `.breadcrumbs/260220.md`
- `USAGE.md`
- `docs/changelog/260220.md`
- `src/.agents/testing.md`
- `src/claude_capture_fallback_test.go`
- `src/claude_session.go`
- `src/codex_session.go`
- `src/codex_session_test.go`
- `src/command_coverage_test.go`
- `src/commands_session_state.go`
- `src/help.go`
- `src/monitor_waiting_turn_complete_test.go`

### QA Notes

- Verify `./lisa session monitor --session <name> --stop-on-waiting true --waiting-requires-turn-complete true --json` exits with `"exitReason":"waiting_input_turn_complete"` for interactive Claude and Codex sessions after assistant completion.
- Verify promptless/custom-command Claude sessions return raw capture payload (no stale `claudeSession` transcript payload) via `./lisa session capture --session <name> --json`.
- Verify Codex strict waiting mode no longer times out when transcript tail includes `task_complete` after assistant output.
- Verify `go test ./...` remains green.
