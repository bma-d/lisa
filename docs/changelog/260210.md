# Changelog - 260210

## 260210-00:55:22 - Harden session status detection and artifact cleanup

### Summary
Improve session-state accuracy, artifact cleanup coverage, and doctor metadata reporting.

### Added
- Build metadata plumbing in app layer via `SetBuildInfo(...)` and new `src/build_info.go`.
- Regression tests covering prompt detection, zero-CPU process detection, cross-project cleanup, and doctor JSON payload.

### Changed
- Prompt-wait detection now inspects recent tail output instead of historical full-capture markers.
- Session artifact cleanup now resolves and removes matching artifacts across project-hash namespaces.

### Fixed
- Prevented stale "tokens used" / "press enter to send" lines from causing false `waiting_input` states.
- Corrected agent PID detection when matching process CPU is `0.0`.
- Removed hardcoded doctor JSON version; now reports runtime build metadata.

### Files
- `main.go`
- `src/build_info.go`
- `src/commands_agent.go`
- `src/session_files.go`
- `src/status.go`
- `src/tmux.go`
- `src/regressions_test.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go vet ./...`
- `go run . doctor --json`

## 260210-01:59:02 - Ensure session termination despite cleanup failures

### Summary
Prioritize tmux session termination over artifact cleanup and enforce strict doctor flag parsing.

### Added
- Regression tests for unknown `doctor` flags and kill-order behavior under cleanup failures.

### Fixed
- `session kill` now attempts tmux termination before artifact cleanup, preventing cleanup errors from leaving sessions alive.
- `session kill-all` now attempts kill for every listed session before reporting cleanup failures.
- `doctor` now rejects unknown flags instead of silently ignoring them.

### Files
- `src/commands_agent.go`
- `src/commands_session.go`
- `src/regressions_test.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`

## 260210-17:29:20 - Harden degraded-state handling and failure observability

### Summary
Surfaced infrastructure read/write failures in status signals, tightened completion trust when metadata is unreadable, and made session cleanup best-effort even when tmux kill fails.

### Added
- New status signals: `metaReadError`, `stateReadError`, and `eventsWriteError` for direct observability in JSON/text status flows.
- Regression coverage for metadata/state parse failures, event append failures, kill/kill-all cleanup on kill errors, and monitor degraded terminal behavior.

### Changed
- `state_lock_timeout` now classifies as `degraded` (not `stuck`) and is treated as a monitor terminal failure reason.
- Session explain text output now prints metadata/state/events error signals when present.
- Status-path regex usage is precompiled to reduce poll-loop CPU overhead.
- Event append flow now trims after append (removed redundant pre-trim pass) to reduce repeated I/O.

### Fixed
- Prevented false completion/crash from session-done markers when session metadata cannot be decoded.
- Prevented stale artifacts from remaining when `session kill` / `session kill-all` encounter tmux kill errors.
- Prevented monitor from timing out on persistent degraded infra states without surfacing the root reason.

### Files
- `.agents/architecture.md`
- `.agents/sdk-usage.md`
- `README.md`
- `src/.agents/state-machine.md`
- `src/commands_session_explain.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/regressions_test.go`
- `src/session_files.go`
- `src/session_observability.go`
- `src/session_wrapper_test.go`
- `src/status.go`
- `src/types.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`
- `go vet ./...`
- `LISA_E2E_CLAUDE=1 go test ./...`
- Manual repro: forced cleanup failures for `session kill` and `session kill-all` verified sessions were still terminated.

## 260210-02:22:38 - Harden exec completion and CLI parsing reliability

### Summary
Prevent stale exec markers from ending active runs and tighten command parsing behavior with direct regression coverage.

### Added
- Regression tests for `Run(version)`, stale vs tail exec completion markers, strict `--stop-on-waiting` validation, and `session spawn` parsing/json paths.
- Injectable tmux function variables for spawn-path testability.

### Changed
- `main` now delegates argument handling fully to `app.Run(...)` so version behavior is consistent for both binary and internal callers.
- `session spawn` now uses function-variable wrappers for tmux dependencies in tests.

### Fixed
- `parseExecCompletion` now ignores historical `__LISA_EXEC_DONE__` markers unless they remain at capture tail.
- `session monitor --stop-on-waiting` now rejects invalid values instead of silently coercing typos.
- `Run()` now handles `version` and version aliases directly.

### Files
- `main.go`
- `src/commands_session.go`
- `src/regressions_test.go`
- `src/run.go`
- `src/status.go`
- `src/tmux.go`
- `src/utils.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go vet ./...`

## 260210-04:07:05 - Address review follow-ups for status and monitor reliability

### Summary
Hardened exec-tail completion checks, made `--stop-on-waiting` parsing strict, and improved machine-safe session command output with expanded regression coverage.

### Added
- Regression tests for tag-like trailing output after exec markers, fish-style prompt tails, and strict rejection of non-literal boolean values.
- Regression tests for spawn send-failure cleanup and mockable tmux paths across `send`, `capture`, `list`, and `exists` command handlers.
- Regression test for CSV-safe status output when active task text contains commas.

### Changed
- `session status` and `session monitor` text output now uses CSV writing with proper escaping.
- Session command handlers now consistently use injectable tmux function variables for better test seams.
- Session output artifact capture now uses `tmuxCapturePaneFn` for deterministic testing.

### Fixed
- Spawn now cleans artifacts after startup command send failure while preserving explicit kill-error visibility.
- Exec completion prompt-tail validation no longer treats arbitrary `>`-terminated lines as prompt markers.
- `--stop-on-waiting` now accepts only literal `true|false` values, matching CLI messaging.
- Docs updated to point to the latest changelog and include `src/build_info.go` in structure references.

### Files
- `.breadcrumbs/260210.md`
- `docs/changelog/260210.md`
- `docs/development-guide.md`
- `docs/index.md`
- `docs/source-tree-analysis.md`
- `src/commands_session.go`
- `src/regressions_test.go`
- `src/session_files.go`
- `src/status.go`
- `src/tmux.go`
- `src/utils.go`

### QA Notes
- `go test ./...`
- `go vet ./...`

## 260210-04:36:29 - Harden waiting detection and missing-session cleanup

### Summary
Prevent false waiting states for active Claude runs and clean stale artifacts even when tmux sessions are already gone.

### Added
- Regression test ensuring tag-like Claude tail output does not force `waiting_input` while agent activity is high.
- Regression test ensuring `session kill` cleans artifacts when the tmux session is missing.

### Changed
- Tightened Claude prompt detection to treat only explicit prompt tails as waiting cues.
- Updated `session kill` to attempt artifact cleanup even on `session not found`.
- Corrected internal context docs to list exactly which commands support `--json`.

### Fixed
- False `waiting_input` state caused by tag-like output ending with `>`.
- Orphaned `/tmp` artifacts left behind when `session kill` targeted a missing tmux session.

### Files
- `src/status.go`
- `src/commands_session.go`
- `src/regressions_test.go`
- `.agents/conventions.md`
- `.agents/project-overview.md`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`
- `go vet ./...`

## 260210-04:46:48 - Harden exec wrapper and cross-shell status detection

### Summary
Make exec completion markers reliable under errexit shells and prevent false in-progress states on non-default shell panes.

### Added
- Regression test for exec wrapper behavior when shell `errexit` mode is active.
- Regression test ensuring stale `pwsh` panes are treated as shell-idle/stuck instead of forced `in_progress`.

### Changed
- Expanded shell command detection to include additional interactive shells (`pwsh`, `tcsh`, `nu`, and `*sh` variants) and path-based command names.

### Fixed
- Exec-mode startup command wrapping now emits `__LISA_EXEC_DONE__` markers reliably even when the pane shell runs with `set -e`.
- Status classification no longer assumes unknown shell binaries imply active work.
- Architecture doc wording corrected from deterministic naming to unique naming.

### Files
- `src/agent_command.go`
- `src/utils.go`
- `src/regressions_test.go`
- `docs/architecture.md`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go vet ./...`
- `go test -race ./...`

## 260210-04:59:02 - Align release targets and session naming constraints

### Summary
Removed unsupported Windows distribution paths and enforced a consistent `lisa-` session naming contract to keep session lifecycle commands reliable.

### Added
- Regression test covering rejection of custom `session spawn --session` values that do not start with `lisa-`.

### Changed
- `session spawn` now validates custom session names and fails fast on invalid prefixes.
- CLI usage and context docs now reflect the required `lisa-` prefix for custom session names.
- Project support/install docs now explicitly target macOS and Linux.

### Fixed
- Prevented Lisa-created sessions from being hidden from `session list` and `session kill-all` due to inconsistent custom names.
- Prevented publishing/install guidance for unsupported Windows runtime paths.

### Removed
- Windows build target and Scoop publishing from release packaging.
- Unused Scoop release token wiring from CI release workflow.

### Files
- `.goreleaser.yaml`
- `.github/workflows/release.yml`
- `README.md`
- `src/commands_session.go`
- `src/run.go`
- `src/regressions_test.go`
- `.agents/project-overview.md`
- `.agents/sdk-usage.md`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go vet ./...`
- `go test -race ./...`
- `rg -n "Scoop|scoop|windows|Windows" README.md .goreleaser.yaml .github/workflows .agents src docs`

## 260210-05:10:56 - Treat empty tmux server as zero sessions

### Summary
Normalize tmux no-server list responses to empty results so session list and kill-all succeed when no sessions exist.

### Changed
- `tmuxListSessions(...)` now maps tmux "no server running" / "no sessions" output to an empty slice instead of a command error.
- Updated tmux layer context docs to document empty-server normalization behavior.

### Fixed
- `lisa session list` no longer fails on fresh environments with no tmux server.
- `lisa session kill-all` now reports `killed 0 sessions` instead of returning a list failure when nothing is running.

### Files
- `src/tmux.go`
- `src/regressions_test.go`
- `src/.agents/tmux-layer.md`
- `docs/changelog/260210.md`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`
- `go run . session list` (with no tmux server)
- `go run . session kill-all` (with no tmux server)

## 260210-17:09:03 - Harden status observability and session command maintainability

### Summary
Improved runtime stability and diagnosability by adding bounded lock behavior, resilient event handling, process-scan caching, and stronger spawn/session command semantics.

### Added
- New session explain command path with structured event-tail reporting and dropped-line counts.
- Codex end-to-end integration test (`LISA_E2E_CODEX=1`) for parity with Claude lifecycle coverage.
- New command modules to split session responsibilities: state/monitoring and management operations.
- Additional regression/wrapper tests for lock timeout classification, malformed/large event lines, event-log trimming, process-scan cache behavior, and metadata persistence failure rollback.

### Changed
- Session status now prefers a combined tmux pane snapshot read before per-field fallback.
- Agent process detection now supports short-lived caching (`LISA_PROCESS_SCAN_INTERVAL_SECONDS`) to reduce poll overhead.
- Event logs now enforce retention limits via `LISA_EVENTS_MAX_BYTES` and `LISA_EVENTS_MAX_LINES`.
- README session state list now includes `just_started`.

### Fixed
- Prevented successful `session spawn` completion when metadata persistence fails; now kills/cleans and returns non-zero.
- Prevented indefinite blocking on state file lock acquisition via timeout (`LISA_STATE_LOCK_TIMEOUT_MS`) with explicit `state_lock_timeout` classification signals.
- Prevented `session explain` failure from single malformed JSONL event rows.
- Prevented oversized single-line event trimming from writing partial/corrupted JSON fragments.

### Files
- `README.md`
- `src/types.go`
- `src/status.go`
- `src/session_observability.go`
- `src/session_wrapper.go`
- `src/session_wrapper_test.go`
- `src/commands_session.go`
- `src/commands_session_state.go`
- `src/commands_session_manage.go`
- `src/commands_session_explain.go`
- `src/e2e_codex_test.go`
- `src/regressions_test.go`
- `src/.agents/state-machine.md`
- `src/.agents/session-lifecycle.md`
- `src/.agents/testing.md`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`

## 260210-18:12:04 - Harden runtime timeouts, event locking, and interactive lifecycle coverage

### Summary
Improved runtime stability and observability by bounding external command execution, serializing event-log writes, and expanding deterministic regression/integration coverage.

### Added
- `signals.agentScanError` plus `agent_scan_error` degraded classification when process scans fail without stronger activity signals.
- Dedicated event-file lock path with timeout control via `LISA_EVENT_LOCK_TIMEOUT_MS`.
- Default-running hermetic interactive integration test: `src/e2e_interactive_fake_test.go`.
- New hardening test suite in `src/hardening_test.go` covering command routing, tmux wrappers, doctor behavior, timeout behavior, and event-log concurrency.

### Changed
- `runCmd`/`runCmdInput` now execute with `exec.CommandContext` timeout bounds via `LISA_CMD_TIMEOUT_SECONDS` (default `20s`).
- Event trimming now enforces both byte and line caps on every trim pass.
- Process scan plumbing now returns explicit errors instead of silently collapsing failures to `(pid=0,cpu=0)`.
- Prompt-tail validation tightened to accept Starship-style prompt trailers while rejecting arbitrary non-prompt lines that only contain prompt glyphs.
- Internal context docs refreshed for new observability/testing/runtime behaviors.

### Fixed
- Prevented potential indefinite hangs on stalled `tmux`/`ps` subprocess calls.
- Prevented concurrent event append/trim races that could corrupt or reorder JSONL observability streams.
- Prevented marker parsing misses when shell prompt lines include trailing duration/time segments.
- Normalized no-match process detection CPU signal to `0.0` instead of `-1.0`.

### Files
- `.breadcrumbs/260210.md`
- `src/.agents/session-lifecycle.md`
- `src/.agents/state-machine.md`
- `src/.agents/testing.md`
- `src/.agents/tmux-layer.md`
- `src/e2e_interactive_fake_test.go`
- `src/hardening_test.go`
- `src/regressions_test.go`
- `src/session_observability.go`
- `src/session_wrapper_test.go`
- `src/status.go`
- `src/tmux.go`
- `src/types.go`
- `src/utils.go`

### QA Notes
- `go test ./... -count=1`
- `go test -race ./...`
- `go test ./... -coverprofile=/tmp/lisa-cover.out && go tool cover -func=/tmp/lisa-cover.out`
- `go test ./src -run TestE2EInteractiveLifecycleWithCat -count=1 -v`
- `go vet ./...`
