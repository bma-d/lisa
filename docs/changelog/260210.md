# Changelog - 260210

## 260210-00:55:22 - Harden session status detection and artifact cleanup

### Summary
Improve session-state accuracy, artifact cleanup coverage, and doctor metadata reporting.

### Added
- Build metadata plumbing in app layer via `SetBuildInfo(...)` and new `src/build_info.go`.
- Regression tests covering prompt detection, zero-CPU process detection, cross-project cleanup, and doctor JSON payload.

### Changed
- Prompt-wait detection now inspects recent tail output instead of historical full-capture markers.
- Session artifact cleanup now resolves and removes matching artifacts across project-hash namespaces.

### Fixed
- Prevented stale "tokens used" / "press enter to send" lines from causing false `waiting_input` states.
- Corrected agent PID detection when matching process CPU is `0.0`.
- Removed hardcoded doctor JSON version; now reports runtime build metadata.

### Files
- `main.go`
- `src/build_info.go`
- `src/commands_agent.go`
- `src/session_files.go`
- `src/status.go`
- `src/tmux.go`
- `src/regressions_test.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go vet ./...`
- `go run . doctor --json`

## 260210-01:59:02 - Ensure session termination despite cleanup failures

### Summary
Prioritize tmux session termination over artifact cleanup and enforce strict doctor flag parsing.

### Added
- Regression tests for unknown `doctor` flags and kill-order behavior under cleanup failures.

### Fixed
- `session kill` now attempts tmux termination before artifact cleanup, preventing cleanup errors from leaving sessions alive.
- `session kill-all` now attempts kill for every listed session before reporting cleanup failures.
- `doctor` now rejects unknown flags instead of silently ignoring them.

### Files
- `src/commands_agent.go`
- `src/commands_session.go`
- `src/regressions_test.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go test -race ./...`
- `LISA_E2E_CLAUDE=1 go test ./...`
- Manual repro: forced cleanup failures for `session kill` and `session kill-all` verified sessions were still terminated.

## 260210-02:22:38 - Harden exec completion and CLI parsing reliability

### Summary
Prevent stale exec markers from ending active runs and tighten command parsing behavior with direct regression coverage.

### Added
- Regression tests for `Run(version)`, stale vs tail exec completion markers, strict `--stop-on-waiting` validation, and `session spawn` parsing/json paths.
- Injectable tmux function variables for spawn-path testability.

### Changed
- `main` now delegates argument handling fully to `app.Run(...)` so version behavior is consistent for both binary and internal callers.
- `session spawn` now uses function-variable wrappers for tmux dependencies in tests.

### Fixed
- `parseExecCompletion` now ignores historical `__LISA_EXEC_DONE__` markers unless they remain at capture tail.
- `session monitor --stop-on-waiting` now rejects invalid values instead of silently coercing typos.
- `Run()` now handles `version` and version aliases directly.

### Files
- `main.go`
- `src/commands_session.go`
- `src/regressions_test.go`
- `src/run.go`
- `src/status.go`
- `src/tmux.go`
- `src/utils.go`
- `.breadcrumbs/260210.md`

### QA Notes
- `go test ./...`
- `go vet ./...`

## 260210-04:07:05 - Address review follow-ups for status and monitor reliability

### Summary
Hardened exec-tail completion checks, made `--stop-on-waiting` parsing strict, and improved machine-safe session command output with expanded regression coverage.

### Added
- Regression tests for tag-like trailing output after exec markers, fish-style prompt tails, and strict rejection of non-literal boolean values.
- Regression tests for spawn send-failure cleanup and mockable tmux paths across `send`, `capture`, `list`, and `exists` command handlers.
- Regression test for CSV-safe status output when active task text contains commas.

### Changed
- `session status` and `session monitor` text output now uses CSV writing with proper escaping.
- Session command handlers now consistently use injectable tmux function variables for better test seams.
- Session output artifact capture now uses `tmuxCapturePaneFn` for deterministic testing.

### Fixed
- Spawn now cleans artifacts after startup command send failure while preserving explicit kill-error visibility.
- Exec completion prompt-tail validation no longer treats arbitrary `>`-terminated lines as prompt markers.
- `--stop-on-waiting` now accepts only literal `true|false` values, matching CLI messaging.
- Docs updated to point to the latest changelog and include `src/build_info.go` in structure references.

### Files
- `.breadcrumbs/260210.md`
- `docs/changelog/260210.md`
- `docs/development-guide.md`
- `docs/index.md`
- `docs/source-tree-analysis.md`
- `src/commands_session.go`
- `src/regressions_test.go`
- `src/session_files.go`
- `src/status.go`
- `src/tmux.go`
- `src/utils.go`

### QA Notes
- `go test ./...`
- `go vet ./...`
