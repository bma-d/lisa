# Changelog - 260225

## 260225-05:32:41 - Align packet cursor and handoff schema contracts

### Summary
Fixed packet cursor compatibility across `session packet` JSON modes and aligned handoff lane-contract schema guidance with runtime behavior.

### Added
- Regression tests for packet cursor legacy parsing, mode roundtrip, and ordered `--json-min` -> `--delta-json` sequence.
- Regression test ensuring `session handoff --schema v4` is accepted when lane contract is `handoff_v2_required`.

### Changed
- Updated handoff schema rejection guidance to `--schema v2|v3|v4`.
- Updated lisa skill docs and validation notes to match packet cursor and handoff schema contracts.

### Fixed
- `session packet --cursor-file ... --json-min` followed by `--delta-json --json` no longer fails with `invalid_cursor_file`.
- Shared cursor offset loading now accepts both numeric and JSON cursor formats.

### Files
- `src/commands_session_packet.go`
- `src/commands_session_orchestration.go`
- `src/session_feature_cluster_b_test.go`
- `src/session_send_handoff_contract_fix_test.go`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/validation.md`

### QA Notes
- Verify `./lisa session packet --cursor-file /tmp/lisa.packet.cursor --json-min` then `./lisa session packet --cursor-file /tmp/lisa.packet.cursor --delta-json --json` exits `0` and has no `errorCode`.
- Verify lane contract `handoff_v2_required` rejects `--schema v1` with `errorCode:"handoff_schema_v2_required"` and guidance `v2|v3|v4`.
- Verify lane contract `handoff_v2_required` accepts `./lisa session handoff --schema v4 --json`.
- Verify `go test ./src` passes.

## 260225-06:11:07 - Close handoff v4 doc/schema drift and harden regressions

### Summary
Aligned remaining v4 handoff contract documentation with runtime behavior and strengthened schema/help regression coverage.

### Added
- Regression test for `session schema --command handoff` typed `nextAction` contract (`string|object` with `commandAst`).
- Regression assertions for handoff v4 behavior across both `--json` and `--json-min` lane-contract flows.
- Regression checks for v4 wording in usage/help surfaces.

### Changed
- Updated `skills/lisa/data/commands.md` and `USAGE.md` `--from-handoff` wording to include v4 object payload support.
- Updated `session schema` handoff catalog to describe typed `nextAction` object shape.
- Synced `.agents/sdk-usage.md` handoff guidance to `v2|v3|v4`.

### Fixed
- Removed final mismatch where docs still implied v2/v3-only object payload handling for `context-pack --from-handoff`.

### Files
- `.agents/sdk-usage.md`
- `USAGE.md`
- `skills/lisa/data/commands.md`
- `src/commands_session_extended.go`
- `src/commands_session_orchestration.go`
- `src/docs_contract_test.go`
- `src/help_test.go`
- `src/session_context_commands_direct_test.go`
- `src/session_send_handoff_contract_fix_test.go`

### QA Notes
- Verify `./lisa session handoff --help` lists `--schema` values `v1|v2|v3|v4`.
- Verify lane contract `handoff_v2_required` rejects `--schema v1` and accepts `--schema v4` for both `--json` and `--json-min`.
- Verify `./lisa session context-pack --from-handoff <handoff-v4.json> --json` succeeds when `nextAction` is object-typed.
- Verify `go test ./src -run 'TestUsageDocSessionContract|TestSkillDocsHandoffSchemaV4Contract|TestCmdSessionSchemaHandoffSupportsTypedNextActionContract|TestCmdSessionHandoffAllowsSchemaV4WhenLaneRequiresV2|TestHelpOutputContainsExpectedTokens'` passes.

## 260225-06:58:16 - Harden skill contracts and add post-use tmux cleanup hygiene

### Summary
Aligned skill/runtime contracts, normalized codex model alias handling, and documented deterministic cleanup of inactive sessions and tmux socket residue after orchestration runs.

### Added
- Regression test for preflight model alias normalization (`codex-spark` -> `gpt-5.3-codex-spark`).
- Regression test enforcing canonical skill flag lexicon coverage for `skills doctor --contract-check`/`session contract-check`.
- Skill runbook guidance for post-use cleanup sequence (`kill-all --project-only` + stale prune preview + cleanup sweep).

### Changed
- `detectMissingSkillFlags` now validates against the canonical lexicon line in `skills/lisa/data/commands.md` rather than incidental flag mentions.
- `session contract-check` now reuses the same canonical lexicon drift detector as `skills doctor`.
- Lisa skill docs updated to keep handoff `v4` contract wording and cleanup guidance aligned across `SKILL.md`, `commands.md`, `recipes.md`, and `validation.md`.

### Fixed
- `./lisa session preflight --agent codex --model codex-spark --json` now succeeds via alias normalization to `gpt-5.3-codex-spark`.
- Flag-surface drift detection now reports true lexicon drift instead of being masked by unrelated flag mentions elsewhere in docs.

### Files
- `.agents/sdk-usage.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/validation.md`
- `src/commands_session_extended.go`
- `src/commands_skills.go`
- `src/commands_skills_doctor_fix_test.go`
- `src/docs_contract_test.go`
- `src/model_flag.go`
- `src/model_flag_test.go`
- `src/session_preflight_model_alias_test.go`
- `docs/changelog/260225.md`

### QA Notes
- Verify `./lisa session preflight --agent codex --model codex-spark --project-root "$(pwd)" --json` returns `ok:true` and `modelCheck.model:"gpt-5.3-codex-spark"`.
- Verify `./lisa session contract-check --project-root "$(pwd)" --json` reports `skill_flag_surface_coverage.ok:true`.
- Verify `./lisa skills doctor --repo-root "$(pwd)" --contract-check --json` reports all targets `up_to_date`.
- Verify post-use cleanup flow: `./lisa session kill-all --project-only --project-root "$(pwd)" --json`, `./lisa session list --project-root "$(pwd)" --stale --prune-preview --json-min`, then `./lisa cleanup --dry-run --json` and `./lisa cleanup --json`.
- Verify `go test ./...` passes.

## 260225-07:25:00 - Add deep stress harness script

### Summary
Added a reusable deep stress runner for Lisa command/runtime contract validation with expected-exit assertions and artifact output.

### Added
- New `scripts/deep-stress.sh` harness covering smoke/chaos, nested detection, long interactive turn churn, autopilot resume, lane/dedupe/guard contracts, and project-scoped cleanup verification.
- CLI options for quick/full mode and configurable model, poll interval, socket directory, and output directory.

### Changed
- Updated project context index to include the new script in the scripts inventory.
- Logged breadcrumbs for implementation details and context refresh.

### Files
- `scripts/deep-stress.sh`
- `.agents/project-overview.md`
- `.breadcrumbs/260225.md`
- `docs/changelog/260225.md`

### QA Notes
- Run `./scripts/deep-stress.sh --quick --project-root /Users/joon/projects/twoj/tools/lisa` and verify `unexpected: 0` in generated `summary.json`.
- Run `./scripts/deep-stress.sh --project-root /Users/joon/projects/twoj/tools/lisa` and verify the script exits `0` and final `session list --project-only` returns `count: 0`.
