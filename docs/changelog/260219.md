# Changelog - 260219

## 260219-03:44:12 - Default raw capture noise stripping and harden nested interactive session behavior

### Summary

Made raw capture noise stripping the default, added `--keep-noise` opt-out, and fixed nested interactive/session routing regressions (`session exists --project-root`, waiting-input detection).

### Added

- Added interactive-shell waiting-input classification using pane process-tree inspection with passive helper (`sleep`) filtering.
- Added `session exists --project-root <path>` support in parser/runtime paths and coverage tests.

### Changed

- Changed `session capture --raw` behavior to strip noise by default.
- Added `--keep-noise` flag to preserve startup noise when needed.
- Kept `--strip-noise` as a compatibility alias.
- Updated help, usage, and context docs to reflect the new capture defaults and session-exists root behavior.

### Fixed

- Fixed custom interactive shell sessions not reliably reaching `waiting_input` under nested lisa-agent usage.
- Fixed project-root scoped existence checks for cross-root/session-routing cases.

### Files

- `.agents/sdk-usage.md`
- `.breadcrumbs/260218.md`
- `.breadcrumbs/260219.md`
- `USAGE.md`
- `docs/changelog/260219.md`
- `src/.agents/state-machine.md`
- `src/claude_session_test.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/coverage_cli_additional_test.go`
- `src/hardening_test.go`
- `src/help.go`
- `src/regressions_test.go`
- `src/status.go`
- `src/tmux.go`
- `src/utils.go`

### QA Notes

- Verify `./lisa session capture <name> --raw` excludes Codex/MCP startup noise by default.
- Verify `./lisa session capture <name> --raw --keep-noise` includes the original startup noise.
- Verify `./lisa session exists <name> --project-root <root>` succeeds for sessions created in that root.
- Verify nested/custom interactive sessions transition to `waiting_input` and `session monitor --stop-on-waiting true` exits with code `0`.
- Verify `go test ./...` remains green.


## 260219-15:39:23 - Harden nested codex tmux behavior and add 3-level interactive smoke command

### Summary

Improved nested Lisa reliability with codex exec fallback guidance, added deterministic L1->L2->L3 interactive smoke coverage, and shipped a runnable repo smoke command.

### Added

- Added `src/e2e_nested_interactive_fake_test.go` for default 3-level nested interactive orchestration coverage.
- Added repo command `./smoke-nested` and implementation script `scripts/smoke-nested-3level.sh` for manual deterministic nested smoke runs.
- Added targeted regression coverage for codex exec nested tmux socket-permission failures.

### Changed

- Updated spawn failure messaging to include codex exec nested tmux fallback guidance (`interactive` mode or explicit unsandboxed codex args).
- Updated shell quoting to use ANSI-C quoting when control characters are present to avoid invalid JSON payload surfaces.
- Updated usage/help/sdk/testing/project context docs for nested codex behavior and smoke workflow.

### Fixed

- Fixed `session spawn --json` multiline/control-char command serialization edge cases that previously produced invalid JSON-like payload behavior.

### Files

- `.agents/conventions.md`
- `.agents/project-overview.md`
- `.agents/sdk-usage.md`
- `.breadcrumbs/260219.md`
- `README.md`
- `USAGE.md`
- `docs/changelog/260219.md`
- `scripts/smoke-nested-3level.sh`
- `smoke-nested`
- `src/.agents/testing.md`
- `src/commands_session.go`
- `src/e2e_nested_interactive_fake_test.go`
- `src/help.go`
- `src/regressions_test.go`
- `src/utils.go`

### QA Notes

- Verify `./smoke-nested` prints `PASS` and all three markers (`NESTED_L1_DONE=1`, `NESTED_L2_DONE=1`, `NESTED_L3_DONE=1`).
- Verify `./smoke-nested --max-polls 30` still passes in local tmux environment.
- Verify codex exec nested spawn failure prints the tmux fallback hint when socket permission errors occur.
- Verify multiline prompt/control-char spawn paths still return valid JSON output and `go test ./...` remains green.
