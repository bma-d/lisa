# Changelog - 260221

## 260221-00:58:47 - Add nested smoke orchestration, monitor expectation gates, and JSON session helpers

### Summary
Implemented deeper session orchestration primitives for LLM workflows: built-in nested smoke, explicit monitor success expectations, and JSON output for session helper commands.

### Added
- Added `session smoke` command with deterministic nested orchestration validation (`--levels` 1-4), marker assertions, and JSON summary output.
- Added `session monitor --expect any|terminal|marker` to enforce expected success conditions.
- Added `session tree --flat` output for low-token machine parsing.
- Added JSON support for `session name|list|exists|kill|kill-all`.
- Added regression/E2E tests for smoke, monitor expectations, flat tree output, and new JSON helper outputs.

### Changed
- Extended session/router/help surfaces to include smoke command and new monitor/tree/manage flags.
- Improved monitor lifecycle reason emission on expectation mismatch paths.

### Files
- `src/commands_session.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/commands_session_tree.go`
- `src/commands_session_smoke.go`
- `src/help.go`
- `src/help_test.go`
- `src/e2e_smoke_fake_test.go`
- `src/session_manage_json_test.go`
- `src/session_monitor_expect_test.go`
- `src/session_tree_flat_test.go`
- `docs/changelog/260221.md`

### QA Notes
- Verify nested validation works end-to-end: `./lisa session smoke --project-root "$(pwd)" --levels 4 --json`.
- Verify expectation gating: `./lisa session monitor --session <s> --until-marker DONE --expect terminal --json` returns mismatch reason when marker is hit first.
- Verify helper JSON outputs parse cleanly for `session name|list|exists|kill|kill-all`.
- Verify test suite remains green: `go test ./...`.

## 260221-00:59:16 - Refresh Lisa docs, skill guide, and context metadata for new session APIs

### Summary
Aligned user docs, skill instructions, and repository context files with the new session smoke command, monitor expectation gates, flat tree output, and expanded JSON command support.

### Changed
- Updated command docs in `USAGE.md` and quick reference in `README.md` for `session smoke`, `monitor --expect`, `tree --flat`, and JSON outputs for helper commands.
- Updated Lisa skill guidance to reflect new runtime semantics and command surfaces for LLM operators.
- Updated AGENTS/context metadata under `.agents/` and `src/.agents/` to match current command contracts and testing coverage.
- Added breadcrumb logs for implementation and context refresh.

### Files
- `AGENTS.md`
- `README.md`
- `USAGE.md`
- `skills/lisa/SKILL.md`
- `.agents/project-overview.md`
- `.agents/sdk-usage.md`
- `src/.agents/session-lifecycle.md`
- `src/.agents/testing.md`
- `.breadcrumbs/260220.md`
- `.breadcrumbs/260221.md`
- `docs/changelog/260221.md`

### QA Notes
- Verify docs command examples match live help output: `./lisa session smoke --help`, `./lisa session monitor --help`, `./lisa session tree --help`, `./lisa session list --help`.
- Verify skill was synced into codex target: `cmp -s skills/lisa/SKILL.md "$HOME/.codex/skills/lisa/SKILL.md"`.
- Verify top-level docs remain coherent with current CLI behavior after release packaging/docs publishing.

## 260221-01:11:13 - Tighten Lisa skill guidance for smoke-first nesting and JSON coverage

### Summary
Updated the repo Lisa skill to match current CLI behavior and simplified nested validation guidance around built-in smoke orchestration.

### Changed
- Bumped `skills/lisa/SKILL.md` metadata date/version to reflect latest validation pass.
- Updated monitor wording/exit semantics to include marker success and expectation-mismatch (`expected_*`) outcomes.
- Replaced manual 4-level nesting script guidance with `./lisa session smoke --levels 4 --json` as the primary deterministic validation path.
- Expanded JSON-support notes to include `skills sync/install` and all session helper commands that now support `--json`.
- Trimmed redundant command-reference content to keep the skill at 500 lines for better LLM efficiency.

### Files
- `skills/lisa/SKILL.md`
- `docs/changelog/260221.md`

### QA Notes
- Verify skill line-budget stays within repo guideline: `wc -l skills/lisa/SKILL.md`.
- Verify build/install path still works after skill edits: `go build -o lisa . && ./lisa skills install`.
- Verify monitor docs align with live help: `./lisa session monitor --help`.

## 260221-01:36:16 - Indexify Lisa project skill for lower token loading

### Summary
Refactored the repo-local Lisa skill into a JIT router + targeted data files so LLMs can load only command, recipe, or runtime context on demand.

### Added
- Added `skills/lisa/data/commands.md` for command contracts, flags, exits, and JSON schemas.
- Added `skills/lisa/data/recipes.md` for orchestration runbooks, nested prompts, and smoke validation snippets.
- Added `skills/lisa/data/runtime.md` for state-machine semantics, artifacts, env overrides, and operational notes.
- Added `skills/lisa/.last-optimiser-hash` for optimiser preflight short-circuiting.

### Changed
- Replaced monolithic `skills/lisa/SKILL.md` with a compact router that dispatches to focused data files.
- Converted frontmatter description to keyword form and bumped version for structural optimization.
- Installed the updated skill bundle to codex/claude targets via `./lisa skills install` (5 files each).

### Files
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/runtime.md`
- `skills/lisa/.last-optimiser-hash`
- `docs/changelog/260221.md`

### QA Notes
- Verify router points to valid docs: `ls -la skills/lisa/data`.
- Verify token reduction: `wc -w skills/lisa/SKILL.md` (before 3136, after 328) and all-skill aggregate reduction (3136 -> 2809).
- Verify install copies nested data files: `./lisa skills install` (expect 5 files per target).

## 260221-04:40:41 - Sync changelog after Lisa skill optimisation commit

### Summary
Added a follow-up changelog note after the skill-optimiser refactor commit; no functional code changes.

### Changed
- Recorded completion state after `refactor(skill): indexify lisa skill for jit loading`.
- Confirmed working tree was clean before writing this follow-up entry.

### Files
- `docs/changelog/260221.md`

### QA Notes
- N/A

## 260221-05:41:32 - Add active-only tree, monitor json-min, nested spawn detection, and JSON error codes

### Summary
Implemented LLM-focused CLI enhancements: active-only session tree views, minimal monitor JSON, nested Codex detection diagnostics, and machine-readable JSON failure codes across commands.

### Added
- Added `session tree --active-only` to filter metadata trees to tmux-active sessions only.
- Added `session monitor --json-min` for low-token orchestration payloads (`session`, `finalState`, `exitReason`, `polls`).
- Added `session spawn --detect-nested` to expose nested Codex bypass/full-auto decision diagnostics in JSON output.
- Added shared JSON error helper and new regression tests for active-only tree, json-min monitor, nested detection output, and JSON error code surfaces.

### Changed
- Standardized JSON-enabled command failure responses to include machine-readable `errorCode` + `error` payloads.
- Updated help output, usage docs, sdk context docs, and Lisa skill docs to document new flags and JSON error contract.
- Synced updated Lisa skill bundle to Codex and Claude skill install targets.

### Fixed
- Fixed metadata-vs-runtime ambiguity by enabling active-only tree filtering for runtime checks.
- Fixed LLM parsing ambiguity on failures by returning structured JSON error identifiers.

### Files
- `src/json_error.go`
- `src/commands_session_tree.go`
- `src/commands_session_state.go`
- `src/commands_session.go`
- `src/commands_session_manage.go`
- `src/commands_session_explain.go`
- `src/commands_session_smoke.go`
- `src/commands_agent.go`
- `src/commands_cleanup.go`
- `src/commands_skills.go`
- `src/help.go`
- `src/session_new_features_test.go`
- `USAGE.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/runtime.md`
- `.agents/sdk-usage.md`
- `docs/changelog/260221.md`

### QA Notes
- Verify active-only filtering: `./lisa session tree --project-root "/Users/joon/projects/twoj/tools/lisa" --active-only --json`.
- Verify minimal monitor schema: `./lisa session monitor --session <name> --json-min`.
- Verify nested detection diagnostics: `./lisa session spawn --agent codex --mode exec --prompt "Use ./lisa" --dry-run --detect-nested --json`.
- Verify structured JSON errors on invalid calls: `./lisa session monitor --session fake --expect marker --json` and confirm `errorCode`.
- Verify regressions: `go test ./... -count=1` and nested runtime check `./lisa session smoke --levels 4 --json`.

## 260221-06:50:41 - Add nested policy controls and incremental capture for LLM orchestration

### Summary
Expanded Lisa with explicit nested policy controls, low-token JSON surfaces, incremental capture deltas, smoke prompt probes, and deterministic timeout/stderr JSON contracts.

### Added
- Added `--nested-policy auto|force|off` to `session spawn` and `agent build-cmd` for explicit Codex nested bypass control.
- Added `--json-min` outputs for `session status`, `session list`, and `session tree` for low-token orchestration loops.
- Added `session capture --raw --delta-from <offset|@unix|RFC3339>` with JSON `deltaMode` + `nextOffset` support.
- Added `session smoke --prompt-style` preflight probes for nested wording trigger validation.
- Added extension regression tests covering nested policy, json-min surfaces, delta capture, timeout normalization, and smoke prompt probes.

### Changed
- Updated all JSON payloads to include `stderrPolicy` for deterministic parser behavior.
- Updated help and usage docs to include nested policy, json-min, capture delta, and prompt-style smoke guidance.
- Updated Lisa skill/router data files and SDK context docs to align with runtime behavior.

### Fixed
- Fixed `session kill --json` missing-session behavior to avoid human stderr text in JSON mode.
- Fixed monitor timeout payload consistency: timeout now reports `finalState=timeout` and `finalStatus=timeout`.

### Files
- `src/commands_session.go`
- `src/commands_agent.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/commands_session_tree.go`
- `src/commands_session_smoke.go`
- `src/utils.go`
- `src/help.go`
- `src/session_feature_extensions_test.go`
- `USAGE.md`
- `skills/lisa/SKILL.md`
- `skills/lisa/data/commands.md`
- `skills/lisa/data/recipes.md`
- `skills/lisa/data/runtime.md`
- `.agents/sdk-usage.md`
- `docs/changelog/260221.md`

### QA Notes
- Verify nested policy force: `./lisa session spawn --agent codex --mode exec --nested-policy force --prompt "No nesting requested here." --dry-run --detect-nested --json`.
- Verify nested policy off: `./lisa session spawn --agent codex --mode exec --nested-policy off --prompt "Use ./lisa" --dry-run --detect-nested --json`.
- Verify low-token status: `./lisa session status --session <name> --json-min`.
- Verify low-token list: `./lisa session list --json-min`.
- Verify low-token tree: `./lisa session tree --json-min`.
- Verify incremental capture loop: `./lisa session capture --session <name> --raw --delta-from 0 --json` then reuse `nextOffset`.
- Verify smoke prompt probes + deep nesting: `./lisa session smoke --levels 4 --prompt-style spawn --json`.
- Verify full regression suite remains green: `go test ./...`.
