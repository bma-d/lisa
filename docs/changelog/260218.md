# Changelog - 260218

## 260218-22:34:57 - Propagate exec failures and close monitor/fallback test gaps

### Summary

Fixed exec-mode failure classification so non-zero commands report crashed state/exit semantics correctly, and added explicit coverage for waiting-input monitor behavior and long-command script fallback.

### Added

- Added end-to-end exec-failure regression asserting `session monitor` returns `finalState=crashed` with exit code `2`.
- Added monitor regression asserting `--stop-on-waiting=false` does not terminate early on `waiting_input`.
- Added explicit long-command (`>500` chars) fallback regression asserting temp script path generation and `respawn-pane` script execution flow.

### Fixed

- Fixed wrapper exit-code propagation so exec command non-zero exits flow through to `__LISA_SESSION_DONE__:<runId>:<code>` instead of being flattened to `:0`.

### Files

- `.breadcrumbs/260218.md`
- `cvelist`
- `cvelist-html`
- `cvelist-our`
- `cvelist-our-html`
- `cvelist.diff`
- `docs/changelog/260218.md`
- `src/agent_command.go`
- `src/command_coverage_test.go`
- `src/e2e_exec_fake_test.go`
- `src/hardening_test.go`
- `src/regressions_test.go`
- `src/session_wrapper.go`

### QA Notes

- Verify failing exec command (`exit 7`) yields `session monitor --json` -> `finalState=crashed`, `exitReason=crashed`, process exit code `2`.
- Verify `session capture --raw --json` includes matching non-zero `__LISA_EXEC_DONE__` and `__LISA_SESSION_DONE__` markers for the same run id.
- Verify `session monitor --stop-on-waiting=false` does not stop on `waiting_input` and can time out when max polls are reached.
- Verify long command spawn/respawn path still executes through `/tmp/lisa-cmd-*` script and returns to shell cleanly.

## 260218-23:32:48 - Route tmux through project sockets and harden nested session routing

### Summary

Scoped tmux runtime to project sockets, resolved implicit project roots from metadata, and added regressions for nested-session safety.

### Added

- Added project-scoped tmux runtime helpers for `LISA_PROJECT_ROOT`/`LISA_TMUX_SOCKET` management and socket path generation.
- Added `resolveSessionProjectRoot` fallback logic so session commands can recover project root from metadata when `--project-root` is omitted.
- Added targeted regression suite covering root resolution precedence/fallbacks, short socket-path invariants, and implicit-root send socket routing.

### Changed

- Updated tmux command execution to consistently route through `tmux -S <project-socket>` and propagate runtime env into spawned panes.
- Updated help/usage/context docs wording and routing notes to reflect unique session naming and socket-based routing.

### Fixed

- Fixed nested tmux failure mode where commands could bind to the wrong server/context under multi-level lisa usage.
- Fixed deep-path socket length risk by moving project socket location to short hashed `/tmp/lisa-tmux-<slug>-<hash>.sock` paths.

### Files

- `.agents/conventions.md`
- `.breadcrumbs/260218.md`
- `USAGE.md`
- `docs/changelog/260218.md`
- `src/command_coverage_test.go`
- `src/commands_session.go`
- `src/commands_session_explain.go`
- `src/commands_session_manage.go`
- `src/commands_session_state.go`
- `src/hardening_test.go`
- `src/help.go`
- `src/regressions_test.go`
- `src/runtime_routing_regression_test.go`
- `src/session_root_resolution.go`
- `src/session_wrapper.go`
- `src/tmux.go`
- `src/tmux_runtime.go`
- `src/utils.go`

### QA Notes

- Verify nested run (`lisa` parent shell -> agent task -> nested `lisa`) can spawn/send/status/capture/kill without `session not found` due to wrong tmux server.
- Verify running from a different cwd without `--project-root` still resolves existing session metadata and sends input successfully.
- Verify deep project paths still create/connect tmux server sockets successfully (no unix socket path length failure).
- Verify `go test ./...` remains green.

