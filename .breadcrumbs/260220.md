# Breadcrumbs 2026-02-20

- **01:35:24**: Add strict monitor turn-complete mode + transcript safety fix
  Implemented --waiting-requires-turn-complete for session monitor; added waiting_input_turn_complete exit reason; fixed Claude capture fallback to raw when prompt/createdAt metadata missing; updated Codex transcript parser to skip task_complete/task_started/agent_reasoning event messages; added regression tests and validated with go test ./... and live CLI runs.
- **01:35:25**: Refresh context docs for monitor/capture changes
  Updated .agents/sdk-usage.md and src/.agents/testing.md with strict monitor mode and promptless transcript fallback behavior.
- **01:37:35**: Harden strict turn-complete mode for Codex transcripts
  Updated codex transcript completion parser to skip non-terminal event_msg entries (task_complete/task_started/agent_reasoning), enabling monitor --waiting-requires-turn-complete to work on Codex interactive sessions; added regression in src/codex_session_test.go.
- **01:37:36**: Split new monitor/capture tests into dedicated files
  Moved new strict monitor tests into src/monitor_waiting_turn_complete_test.go and Claude capture fallback test into src/claude_capture_fallback_test.go to keep command_coverage_test.go near target size and reduce growth in large test files.
- **02:34:33** (`src/status.go`): Fix interactive custom-command waiting detection
  Treat stdin-only cat descendants as passive so monitor --stop-on-waiting reaches waiting_input for interactive custom command sessions instead of timing out; added regressions and e2e coverage.
- **02:34:37** (`src/commands_session.go`): Prioritize session send argument validation
  Reordered cmdSessionSend validation to fail fast on invalid --text/--keys combinations before tmux session lookup; added unit coverage for validation-order behavior.
- **02:34:41** (`src/.agents/state-machine.md`): Refresh state-machine context docs
  Documented stdin-only cat descendant handling in interactive idle detection and updated Last Updated date after waiting_input reliability fix.
- **03:32:17**: Fix session-list missing-socket handling and codex noise filter
  Normalized tmux list-sessions missing-socket errors to empty list for project-scoped list flows; wrapped unexpected tmux list errors with stderr output; expanded raw capture noise filtering for Codex MCP OAuth invalid_grant/auth-refresh lines and continuation fragments; added regression tests.
- **03:32:18**: Refresh context docs for tmux/capture behavior
  Updated src/.agents/tmux-layer.md and .agents/sdk-usage.md to document missing-socket normalization and expanded default raw noise filtering coverage.
- **03:33:11**: Document nested prompt quoting guidance
  Updated USAGE.md and .agents/sdk-usage.md with heredoc-based --prompt guidance for deep nested agent chains to avoid shell quoting collisions.
- **04:08:09**: Fix nested codex + session tree kill
  Patched tmux socket routing to prefer /tmp with legacy fallback, added nested codex exec auto-bypass heuristic for Lisa prompts, added parentSession metadata and descendant-aware cmdSessionKill cascade, added status --fail-not-found, updated help/USAGE, and added regression coverage.
- **04:08:10**: Refresh context docs
  Updated .agents/sdk-usage.md, src/.agents/session-lifecycle.md, and src/.agents/tmux-layer.md to document nested codex bypass behavior, parentSession metadata, descendant kill cascade, and tmux socket routing updates.
- **05:04:12**: Fix status+build-cmd+turn-complete
  Resolved status waiting-input mismatch by using effective persisted poll count; aligned agent build-cmd nested codex bypass with session spawn; hardened waiting_input_turn_complete for Codex by requiring transcript freshness after latest submitted input plus recent session-matched Codex history turn; added regression tests and helper tests; verified go test ./..., smoke-nested, and live CLI repro matrix.
- **05:15:17**: Add top-level cleanup command
  Implemented lisa cleanup command to remove stale tmux socket residue and kill detached (no-client) Lisa tmux servers. Added flags --dry-run, --json, --include-tmux-default; wired Run/help/docs; added targeted tests and verified go test ./... and live dry-run output.
- **05:16:51**: Fix explicit tmux socket override bug
  Fixed runTmuxCmdWithSocket to honor provided socketPath (it previously ignored the argument) and added regression test ensuring explicit socket is used even when LISA_TMUX_SOCKET is set differently.
- **06:03:30**: Normalize terminal session status output
  Updated cmdSessionStatus to map terminal sessionState (completed/crashed/stuck/not_found) into status for JSON/CSV output; added regression tests and USAGE note to prevent idle-vs-terminal mismatch confusion.
- **06:03:41**: Sync SDK context doc for status normalization
  Updated .agents/sdk-usage.md integration notes to document terminal-state status normalization in session status JSON/CSV outputs.
- **06:10:12**: Normalize monitor finalStatus for terminal states
  Updated cmdSessionMonitor to normalize finalStatus for completed/crashed/stuck/not_found results (JSON/CSV + lifecycle event payloads), added regression tests, and updated usage/sdk docs.
- **06:11:29**: Align monitor verbose status with terminal normalization
  Updated monitor --verbose poll logging to print normalized terminal status labels, preventing state=completed/status=idle mixed messaging; updated command_coverage_test expectation and revalidated tests.
- **07:08:49**: Fix monitor/status turn-complete consistency + explain normalization
  Persist waiting_input_turn_complete markers in session state, surface cached transcript signals in status, normalize session explain terminal status, add regression tests, rebuild and verify live with ./lisa.
- **07:12:20**: Verify fixes + regression sweep
  Rebuilt ./lisa, ran go test ./..., ran ./smoke-nested 3-level pass, revalidated waiting_input_turn_complete->status transcriptTurnComplete=true, revalidated explain status normalization crashed|crashed, cleaned stale sockets.
- **07:24:05**: Sync usage + lisa skill docs with CLI behavior
  Used multiple subagents to audit code/docs. Updated USAGE.md for cleanup behavior, explain normalization note, waiting_input_turn_complete lifecycle note, capture --strip-noise alias, spawn env note, and kill behavior details. Updated src/help.go capture help to include --strip-noise alias. Synced /Users/joon/.codex/skills/lisa/SKILL.md with spawn codex-exec notes, monitor exit-code wording, explain normalization note, capture alias flag, and runtime vars LISA_PROJECT_ROOT/LISA_TMUX_SOCKET.
- **07:37:07**: Doc polish sweep before commit
  Performed duplicate/wording polish sweep on USAGE.md and lisa skill parity. Added cleanup behavior details, explain normalization note, monitor waiting_input_turn_complete lifecycle note, capture --strip-noise alias in docs/help, session kill behavior clarifications, and spawn env-routing note; synced lisa SKILL spawn notes for non-nested/full-auto caveat and heredoc guidance. Verified go test ./... passes.
